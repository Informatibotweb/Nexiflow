<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexiflow - Create a Channel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;700&family=Lobster&family=Source+Code+Pro&family=Oswald&family=Playfair+Display&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .draggable { position: absolute; cursor: move; user-select: none; }
        .draggable.selected { outline: 2px dashed #3b82f6; outline-offset: 4px; }
        .draggable[data-locked="true"].selected { outline: 2px dashed #ef4444; cursor: not-allowed; }
        
        .resizer { width: 10px; height: 10px; background: #3b82f6; position: absolute; right: -5px; bottom: -5px; cursor: se-resize; display: none; z-index: 10; }
        .selected .resizer { display: block; }
        .draggable[data-locked="true"] .resizer { display: none; }

        .quick-delete-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 24px;
            height: 24px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            border: 2px solid white;
            font-size: 14px;
            line-height: 1;
        }
        .selected .quick-delete-btn { display: flex; }

        #canvas { width: 100%; height: 100%; position: relative; overflow: hidden; background-color: white; }
        #canvas > * { padding: 8px; box-sizing: border-box; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .prop-btn { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background-color: #374151; border-radius: 0.375rem; transition: background-color 0.2s; font-weight: bold; }
        .prop-btn:hover { background-color: #4b5563; }
        .prop-btn.active { background-color: #3b82f6; }
        #layers-panel .layer-item { display: flex; align-items: center; padding: 8px; background-color: #374151; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; border: 1px solid transparent; }
        #layers-panel .layer-item:hover { background-color: #4b5563; }
        #layers-panel .layer-item.selected { background-color: #3b82f6; border-color: #60a5fa; }
        #layers-panel .layer-item.dragging { opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen overflow-hidden">

    <div id="name-screen" class="flex flex-col items-center justify-center h-full w-full bg-gray-900 absolute top-0 left-0 z-50">
        <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full">
            <h1 class="text-4xl font-bold mb-2">Nexiflow</h1>
            <h2 class="text-xl text-blue-400 mb-6">Create a Channel</h2>
            <p class="text-gray-400 mb-6">Dai un nome al tuo nuovo canale/sito. Ricorda, deve terminare con "channel".</p>
            <form id="name-form" class="flex flex-col gap-4">
                <input type="text" id="channel-name-input" placeholder="es. my-awesome-channel" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <p id="name-error" class="text-red-400 text-sm hidden">Il nome deve finire con "channel".</p>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">Inizia a Creare</button>
            </form>
        </div>
    </div>

    <div id="editor-screen" class="hidden h-full w-full">
        <div class="flex h-full">
            <aside class="w-80 bg-gray-800 p-4 flex flex-col h-full overflow-y-auto shrink-0 space-y-6">
                <div>
                    <h2 class="text-2xl font-bold border-b border-gray-700 pb-2 mb-4">Livelli</h2>
                    <div id="layers-panel" class="space-y-2">
                        <p class="text-gray-400 text-sm">Aggiungi elementi per vederli qui.</p>
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-700">
                    <h2 class="text-2xl font-bold border-b border-gray-700 pb-2 mb-4">Aggiungi</h2>
                    <div class="space-y-3 mb-6">
                        <h3 class="font-semibold text-lg">Sfondo Pagina</h3>
                        <div>
                            <label for="bg-color" class="block text-sm font-medium text-gray-300">Colore</label>
                            <input type="color" id="bg-color" value="#FFFFFF" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-md cursor-pointer">
                        </div>
                        <div>
                            <label for="bg-image" class="block text-sm font-medium text-gray-300">Immagine</label>
                            <input type="file" id="bg-image" accept="image/*" class="text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                        </div>
                         <button id="remove-bg-image" class="w-full text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Rimuovi Immagine</button>
                    </div>
                     <div class="space-y-3 mb-6">
                        <h3 class="font-semibold text-lg">✨ Modelli</h3>
                        <button id="load-template-btn" class="w-full bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Carica un Modello</button>
                    </div>
                    <div class="space-y-3 mb-6">
                        <h3 class="font-semibold text-lg">Elementi</h3>
                         <input type="text" id="text-input" placeholder="Scrivi qualcosa..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                         <button id="add-text-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Aggiungi Testo</button>
                         <button id="ai-text-btn" class="w-full bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                            ✨ Genera Testo con IA
                         </button>
                         <label for="add-image-input" class="w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 cursor-pointer">Aggiungi Immagine</label>
                         <input type="file" id="add-image-input" accept="image/*" class="hidden">
                         <button id="ai-image-btn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                            ✨ Genera Immagine con IA
                         </button>
                         <button id="add-nexiflow-icon" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Aggiungi Icona Nexiflow</button>
                    </div>
                    <div class="space-y-3">
                        <h3 class="font-semibold text-lg">Incorpora</h3>
                         <textarea id="embed-input" placeholder="Incolla qui il codice <iframe>..." rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                         <button id="add-embed-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded-lg transition duration-300">Aggiungi Incorporazione</button>
                    </div>
                </div>
                <div class="!mt-auto pt-6 border-t border-gray-700">
                    <h3 class="font-semibold mb-3 text-lg">Finalizza</h3>
                    <p id="nexiflow-warning" class="text-xs text-yellow-400 mb-3 hidden">Ricorda di aggiungere l'icona Nexiflow.</p>
                    <button id="download-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Scarica File HTML
                    </button>
                </div>
            </aside>
            
            <main class="flex-1 bg-gray-900 p-6 flex items-center justify-center">
                <div class="w-full h-full max-w-7xl aspect-video bg-gray-700 shadow-2xl rounded-lg overflow-hidden">
                    <div id="canvas"></div>
                </div>
            </main>

            <aside id="properties-panel" class="w-80 bg-gray-800 p-4 flex-col h-full overflow-y-auto space-y-6 shrink-0 hidden">
                <h2 class="text-2xl font-bold border-b border-gray-700 pb-2">Proprietà</h2>
                <div id="text-properties" class="hidden space-y-4">
                     <div>
                        <label for="font-family" class="block text-sm font-medium text-gray-300">Font</label>
                        <select id="font-family" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                            <option value="Inter">Inter</option> <option value="Roboto">Roboto</option> <option value="Lobster">Lobster</option> <option value="Source Code Pro">Source Code Pro</option> <option value="Oswald">Oswald</option> <option value="'Playfair Display'">Playfair Display</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                             <label for="font-size" class="block text-sm font-medium text-gray-300">Dimensione (px)</label>
                             <input type="number" id="font-size" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                        </div>
                        <div>
                             <label for="font-color" class="block text-sm font-medium text-gray-300">Colore</label>
                             <input type="color" id="font-color" class="w-12 h-10 p-1 bg-gray-700 border border-gray-600 rounded-md cursor-pointer">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Stile</label>
                        <div class="flex items-center gap-2">
                            <button id="font-bold" class="prop-btn">B</button> <button id="font-italic" class="prop-btn"><em>I</em></button> <button id="font-underline" class="prop-btn"><u>U</u></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Allineamento</label>
                        <div class="flex items-center gap-2">
                            <button id="align-left" class="prop-btn">L</button> <button id="align-center" class="prop-btn">C</button> <button id="align-right" class="prop-btn">R</button>
                        </div>
                    </div>
                    <div>
                        <label for="text-shadow" class="block text-sm font-medium text-gray-300">Ombra Testo</label>
                        <input type="checkbox" id="text-shadow" class="w-5 h-5 bg-gray-700 rounded border-gray-600">
                    </div>
                </div>
                <div id="image-properties" class="hidden space-y-4">
                    <div>
                        <label for="image-link" class="block text-sm font-medium text-gray-300">Link URL (cliccabile)</label>
                        <input type="text" id="image-link" placeholder="https://..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                    </div>
                     <div>
                        <label for="image-width" class="block text-sm font-medium text-gray-300">Larghezza (px)</label>
                        <input type="number" id="image-width" min="10" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                    </div>
                    <div>
                        <label for="image-opacity" class="block text-sm font-medium text-gray-300">Opacità</label>
                        <input type="range" id="image-opacity" min="0" max="1" step="0.1" value="1" class="w-full">
                    </div>
                </div>
                 <div id="common-properties" class="hidden pt-6 border-t border-gray-700 space-y-2">
                    <button id="lock-element-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                        <svg id="unlock-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-unlock-fill" viewBox="0 0 16 16"><path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/></svg>
                        <svg id="lock-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill hidden" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
                        <span id="lock-text">Blocca Elemento</span>
                    </button>
                    <button id="delete-element-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Elimina Elemento</button>
                 </div>
            </aside>
        </div>
    </div>
    
    <div id="download-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 max-w-lg w-full text-center shadow-2xl">
            <h3 class="text-2xl font-bold mb-4">Istruzioni per la Pubblicazione</h3>
            <p class="text-gray-300 mb-6">Per mettere online il tuo canale, segui questi passaggi. <strong class="text-yellow-400">È importante non rinominare il file!</strong></p>
            <div class="text-left bg-gray-900 p-4 rounded-md space-y-2 mb-6">
                <p>1. Vai su GitHub: <a href="https://github.com/Informatibotweb/Nexiflow" target="_blank" class="text-blue-400 hover:underline">github.com/Informatibotweb/Nexiflow</a></p>
                <p>2. Clicca su <code class="bg-gray-700 px-1.5 py-0.5 rounded-sm text-sm">Add file</code> > <code class="bg-gray-700 px-1.5 py-0.5 rounded-sm text-sm">Upload files</code>.</p>
                <p>3. Trascina il file <code id="modal-filename" class="bg-gray-700 px-1.5 py-0.5 rounded-sm text-sm"></code> che stai per scaricare.</p>
                <p>4. Clicca su <code class="bg-gray-700 px-1.5 py-0.5 rounded-sm text-sm">Commit changes</code> in fondo alla pagina.</p>
            </div>
            <div class="flex justify-center gap-4">
                <button id="cancel-download-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Annulla</button>
                <button id="confirm-download-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Capito, Scarica</button>
            </div>
        </div>
    </div>
    <div id="ai-text-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 max-w-lg w-full shadow-2xl relative">
            <button id="close-ai-text-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h3 class="text-2xl font-bold mb-4">✨ Genera Testo con l'IA</h3>
            <p class="text-gray-300 mb-6">Descrivi il testo che vuoi creare (es. "un titolo accattivante per un blog di cucina").</p>
            <form id="ai-text-form">
                <textarea id="ai-text-prompt" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="La mia richiesta..."></textarea>
                <button type="submit" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Genera</button>
            </form>
            <div id="ai-text-loader" class="hidden mt-4 text-center text-blue-300">Sto scrivendo...</div>
            <div id="ai-text-error" class="hidden mt-4 p-3 bg-red-900 text-red-200 rounded-md"></div>
        </div>
    </div>
    <div id="ai-image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 max-w-lg w-full shadow-2xl relative">
            <button id="close-ai-image-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h3 class="text-2xl font-bold mb-4">✨ Genera Immagine con l'IA</h3>
            <p class="text-gray-300 mb-6">Descrivi l'immagine che vuoi creare (es. "un astronauta che cavalca un cavallo sulla luna, stile pittura ad olio").</p>
            <form id="ai-image-form">
                <textarea id="ai-image-prompt" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="La mia richiesta..."></textarea>
                <button type="submit" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Genera</button>
            </form>
            <div id="ai-image-loader" class="hidden mt-4 text-center text-purple-300">Sto disegnando... (potrebbe richiedere un po' di tempo)</div>
            <div id="ai-image-error" class="hidden mt-4 p-3 bg-red-900 text-red-200 rounded-md"></div>
        </div>
    </div>
    <div id="template-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 max-w-3xl w-full shadow-2xl relative">
            <button id="close-template-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h3 class="text-2xl font-bold mb-4">✨ Scegli un Modello</h3>
            <p class="text-gray-300 mb-6">Seleziona un punto di partenza per il tuo canale. Il contenuto attuale verrà sostituito.</p>
            <div id="template-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (variabili e riferimenti DOM esistenti)
            let channelName = '';
            let selectedElement = null;
            let nexiflowIconAdded = false;
            let elementCounter = 0;
            
            const nameScreen = document.getElementById('name-screen');
            const editorScreen = document.getElementById('editor-screen');
            const nameForm = document.getElementById('name-form');
            const nameInput = document.getElementById('channel-name-input');
            const nameError = document.getElementById('name-error');
            const canvas = document.getElementById('canvas');
            const layersPanel = document.getElementById('layers-panel');
            
            const bgColorInput = document.getElementById('bg-color');
            const bgImageInput = document.getElementById('bg-image');
            const removeBgImageBtn = document.getElementById('remove-bg-image');
            const addTextBtn = document.getElementById('add-text-btn');
            const textInput = document.getElementById('text-input');
            const addImageInput = document.getElementById('add-image-input');
            const addEmbedBtn = document.getElementById('add-embed-btn');
            const embedInput = document.getElementById('embed-input');
            const addNexiflowIconBtn = document.getElementById('add-nexiflow-icon');
            const downloadBtn = document.getElementById('download-btn');
            const nexiflowWarning = document.getElementById('nexiflow-warning');

            const propertiesPanel = document.getElementById('properties-panel');
            const textProperties = document.getElementById('text-properties');
            const imageProperties = document.getElementById('image-properties');
            const commonProperties = document.getElementById('common-properties');
            const fontFamilySelect = document.getElementById('font-family');
            const fontSizeInput = document.getElementById('font-size');
            const fontColorInput = document.getElementById('font-color');
            const fontBoldBtn = document.getElementById('font-bold');
            const fontItalicBtn = document.getElementById('font-italic');
            const fontUnderlineBtn = document.getElementById('font-underline');
            const alignLeftBtn = document.getElementById('align-left');
            const alignCenterBtn = document.getElementById('align-center');
            const alignRightBtn = document.getElementById('align-right');
            const textShadowCheckbox = document.getElementById('text-shadow');
            const imageLinkInput = document.getElementById('image-link');
            const imageWidthInput = document.getElementById('image-width');
            const imageOpacityInput = document.getElementById('image-opacity');
            const deleteElementBtn = document.getElementById('delete-element-btn');
            const lockElementBtn = document.getElementById('lock-element-btn');
            const lockText = document.getElementById('lock-text');
            const lockIcon = document.getElementById('lock-icon');
            const unlockIcon = document.getElementById('unlock-icon');
            
            const downloadModal = document.getElementById('download-modal');
            const modalFilename = document.getElementById('modal-filename');
            const cancelDownloadBtn = document.getElementById('cancel-download-btn');
            const confirmDownloadBtn = document.getElementById('confirm-download-btn');

            const aiTextBtn = document.getElementById('ai-text-btn');
            const aiImageBtn = document.getElementById('ai-image-btn');
            const aiTextModal = document.getElementById('ai-text-modal');
            const aiImageModal = document.getElementById('ai-image-modal');
            const closeAiTextModalBtn = document.getElementById('close-ai-text-modal');
            const closeAiImageModalBtn = document.getElementById('close-ai-image-modal');
            const aiTextForm = document.getElementById('ai-text-form');
            const aiImageForm = document.getElementById('ai-image-form');
            const aiTextPrompt = document.getElementById('ai-text-prompt');
            const aiImagePrompt = document.getElementById('ai-image-prompt');
            const aiTextLoader = document.getElementById('ai-text-loader');
            const aiImageLoader = document.getElementById('ai-image-loader');
            const aiTextError = document.getElementById('ai-text-error');
            const aiImageError = document.getElementById('ai-image-error');
            
            // Riferimenti Modelli
            const loadTemplateBtn = document.getElementById('load-template-btn');
            const templateModal = document.getElementById('template-modal');
            const closeTemplateModalBtn = document.getElementById('close-template-modal');
            const templateList = document.getElementById('template-list');

            // --- DEFINIZIONE MODELLI ---
            const templates = [
                {
                    name: "Portfolio Fotografico",
                    description: "Un layout pulito e scuro, ideale per mostrare le tue foto.",
                    thumbnail: "https://placehold.co/400x300/2d3748/ffffff?text=Portfolio",
                    background: { color: "#2d3748" },
                    elements: [
                        { type: 'text', options: { text: "Il Mio Portfolio", top: "50px", left: "50px", style: { fontSize: "60px", color: "white", fontFamily: "'Playfair Display'" }}},
                        { type: 'text', options: { text: "Catturando momenti unici.", top: "120px", left: "55px", style: { fontSize: "20px", color: "#a0aec0", fontFamily: "Inter" }}},
                        { type: 'image', options: { src: "https://placehold.co/300x400/4a5568/e2e8f0?text=Foto+1", top: "200px", left: "50px", width: "250px" }},
                        { type: 'image', options: { src: "https://placehold.co/300x200/4a5568/e2e8f0?text=Foto+2", top: "200px", left: "350px", width: "300px" }},
                        { type: 'image', options: { src: "https://placehold.co/300x250/4a5568/e2e8f0?text=Foto+3", top: "430px", left: "350px", width: "300px" }},
                    ]
                },
                {
                    name: "Articolo di Blog",
                    description: "Un design moderno e arioso per i tuoi articoli e pensieri.",
                    thumbnail: "https://placehold.co/400x300/f7fafc/2d3748?text=Blog",
                    background: { color: "#f7fafc" },
                    elements: [
                        { type: 'image', options: { src: "https://placehold.co/800x400/cbd5e0/4a5568?text=Immagine+Copertina", top: "50px", left: "50px", width: "800px" }},
                        { type: 'text', options: { text: "Titolo del Mio Articolo Fantastico", top: "480px", left: "50px", style: { fontSize: "48px", color: "#2d3748", fontFamily: "Oswald" }}},
                        { type: 'text', options: { text: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.", top: "550px", left: "50px", style: { fontSize: "18px", color: "#4a5568", fontFamily: "Roboto", width: "800px" }}},
                    ]
                }
            ];

            // ... (funzioni esistenti)

            const createElement = (type, options = {}) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'draggable';
                wrapper.style.top = options.top || '50px';
                wrapper.style.left = options.left || '50px';
                wrapper.dataset.type = type;
                wrapper.dataset.id = `el-${elementCounter++}`;
                if(options.isNexiflow) wrapper.dataset.nexiflowIcon = 'true';
                
                let element;
                switch (type) {
                    case 'text':
                        element = document.createElement('div');
                        element.textContent = options.text || 'Testo di esempio';
                        element.style.fontSize = '20px';
                        element.style.color = 'black';
                        element.style.fontFamily = 'Inter';
                        element.setAttribute('contenteditable', 'true');
                        if (options.style) { Object.assign(element.style, options.style); }
                        wrapper.appendChild(element);
                        break;
                    case 'image':
                        const linkWrapper = document.createElement('a');
                        if (options.href) { linkWrapper.href = options.href; linkWrapper.target = '_blank'; }
                        element = document.createElement('img');
                        element.src = options.src;
                        element.style.width = options.width || '150px';
                        element.style.height = 'auto';
                        if (options.style) { Object.assign(element.style, options.style); }
                        linkWrapper.appendChild(element);
                        wrapper.appendChild(linkWrapper);
                        break;
                    case 'embed':
                        wrapper.innerHTML = options.code;
                        const iframe = wrapper.querySelector('iframe');
                        if(iframe) { iframe.style.width = '100%'; iframe.style.height = '100%'; }
                        wrapper.style.width = '300px';
                        wrapper.style.height = '200px';
                        wrapper.style.resize = 'both';
                        wrapper.style.overflow = 'hidden';
                        break;
                }
                makeInteractive(wrapper);
                canvas.appendChild(wrapper);
                selectElement(wrapper);
                updateLayersPanel();
                return wrapper;
            };

            function makeInteractive(element) {
                // Quick Delete Button
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'quick-delete-btn';
                deleteBtn.innerHTML = '&#x1F5D1;'; // Trash can emoji
                deleteBtn.title = 'Elimina Elemento';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteElement(element);
                };
                element.appendChild(deleteBtn);

                element.onmousedown = (e) => {
                    if (e.target.closest('[contenteditable="true"]') || element.dataset.locked === 'true') return;
                    selectElement(element);
                    e.preventDefault();
                    const canvasRect = canvas.getBoundingClientRect();
                    let shiftX = e.clientX - element.getBoundingClientRect().left;
                    let shiftY = e.clientY - element.getBoundingClientRect().top;

                    const moveAt = (clientX, clientY) => {
                        let newLeft = clientX - canvasRect.left - shiftX;
                        let newTop = clientY - canvasRect.top - shiftY;
                        element.style.left = newLeft + 'px';
                        element.style.top = newTop + 'px';
                    };
                    const onMouseMove = (event) => moveAt(event.clientX, event.clientY);
                    document.addEventListener('mousemove', onMouseMove);
                    document.onmouseup = () => { document.removeEventListener('mousemove', onMouseMove); document.onmouseup = null; };
                };
                element.ondragstart = () => false;

                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                element.appendChild(resizer);
                resizer.addEventListener('mousedown', (e) => {
                    if (element.dataset.locked === 'true') return;
                    e.stopPropagation(); e.preventDefault();
                    let original_w = parseFloat(getComputedStyle(element, null).getPropertyValue('width').replace('px', ''));
                    let original_mouse_x = e.pageX;
                    const resize = (ev) => {
                        const width = original_w + (ev.pageX - original_mouse_x);
                        if (width > 20) element.style.width = width + 'px';
                    }
                    const stopResize = () => { document.removeEventListener('mousemove', resize); document.removeEventListener('mouseup', stopResize); }
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                });
            }
            
            function deleteElement(element) {
                if(!element) return;
                if (element.dataset.nexiflowIcon === 'true') { 
                    nexiflowIconAdded = false; 
                    updateDownloadButtonState(); 
                }
                element.remove();
                if (selectedElement === element) {
                    deselectAll();
                }
                updateLayersPanel();
            }
            
            deleteElementBtn.addEventListener('click', () => deleteElement(selectedElement));

            // --- LOGICA MODELLI ---
            loadTemplateBtn.addEventListener('click', () => {
                templateList.innerHTML = '';
                templates.forEach((template, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors flex flex-col';
                    card.innerHTML = `
                        <img src="${template.thumbnail}" alt="${template.name}" class="w-full h-40 object-cover rounded-md mb-4">
                        <h4 class="font-bold text-lg">${template.name}</h4>
                        <p class="text-sm text-gray-400 flex-grow">${template.description}</p>
                    `;
                    card.onclick = () => {
                        if (confirm('Caricando un modello, il contenuto attuale verrà eliminato. Continuare?')) {
                            loadTemplate(index);
                            templateModal.classList.add('hidden');
                        }
                    };
                    templateList.appendChild(card);
                });
                templateModal.classList.remove('hidden');
            });
            
            closeTemplateModalBtn.addEventListener('click', () => templateModal.classList.add('hidden'));

            function loadTemplate(templateIndex) {
                const template = templates[templateIndex];
                
                // Pulisci canvas e stato
                canvas.innerHTML = '';
                elementCounter = 0;
                nexiflowIconAdded = false;
                deselectAll();

                // Imposta sfondo
                if (template.background.color) {
                    canvas.style.backgroundColor = template.background.color;
                    bgColorInput.value = template.background.color;
                    canvas.style.backgroundImage = 'none';
                }
                if (template.background.image) {
                     canvas.style.backgroundImage = `url(${template.background.image})`;
                     canvas.style.backgroundSize = 'cover';
                     canvas.style.backgroundPosition = 'center';
                }

                // Crea elementi
                template.elements.forEach(el => {
                    // Temporaneamente assegna una larghezza in pixel per il posizionamento, verrà ricalcolato al download
                    const newEl = createElement(el.type, el.options);
                    if (el.options.style && el.options.style.width) {
                        newEl.style.width = el.options.style.width;
                    }
                });
                
                updateLayersPanel();
                updateDownloadButtonState();
            }

            // ... (resto dello script, incluse le funzioni di inizializzazione e API Gemini)
            nameForm.addEventListener('submit', (e) => { e.preventDefault(); const name = nameInput.value.trim(); if (name.toLowerCase().endsWith('channel')) { channelName = name; nameScreen.classList.add('hidden'); editorScreen.classList.remove('hidden'); updateDownloadButtonState(); } else { nameError.classList.remove('hidden'); } });
            nameInput.addEventListener('input', () => { nameError.classList.add('hidden'); });
            bgColorInput.addEventListener('input', (e) => { canvas.style.backgroundColor = e.target.value; canvas.style.backgroundImage = 'none'; });
            bgImageInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { canvas.style.backgroundImage = `url(${event.target.result})`; canvas.style.backgroundSize = 'cover'; canvas.style.backgroundPosition = 'center'; }; reader.readAsDataURL(file); } });
            removeBgImageBtn.addEventListener('click', () => { canvas.style.backgroundImage = 'none'; bgColorInput.value = '#FFFFFF'; canvas.style.backgroundColor = '#FFFFFF'; bgImageInput.value = ''; });
            addTextBtn.addEventListener('click', () => { createElement('text', { text: textInput.value || 'Nuovo Testo' }); textInput.value = ''; });
            addImageInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => createElement('image', { src: event.target.result }); reader.readAsDataURL(file); } e.target.value = ''; });
            addEmbedBtn.addEventListener('click', () => { const code = embedInput.value.trim(); if(code.startsWith('<iframe') && code.endsWith('>')) { createElement('embed', { code: code }); embedInput.value = ''; } else { alert('Per favore, inserisci un codice <iframe> valido.'); } });
            addNexiflowIconBtn.addEventListener('click', () => { if (nexiflowIconAdded) return alert('Hai già aggiunto l-icona di Nexiflow!'); const nexiflowPNG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAYFBMVEX9/f0AAAD8/Pz5+fn4+Pj09PTs7Ozr6+vo6Oje3t7X19fS0tLPz8+7u7uysrKpqamioqKdnZ2YmJimpqaZmZmgoKCJiYmVlZWMjIyUlJSKiop4eHhwcHBvb29sbGxiYmJhYWHCtR4FAAAFSElEQVR4nO2di3aiMBCGIQRiL4sLKyjutYj//5UnSqLgSbOSdMyZ3GfvWbIO2LAl8zgzIYIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCMK/kFw2i06SJLlcFpIkub8sk5fL5qWTJCmWy2bX5LL5tGySFL1sFp0kSbrZLDpJkuR62SyapKTeOpPkuGySJLVxJlNuBEkqoZNJ+tMkKUxNJklyfJIk9TGT5Lgsi1SSxuTJJD1NkmJzNiVJvHUiKVVNktLkySQ5LgtUkhZmsiR570wipdpMklRjJklSuJkkSV3ZpCTxsUkS1WZ2SVIzZpJkgUqSnszkJSnsZJIkTWY2SVIzZpJk9TNJk6QWMyVJ3JtNktTMmUyS5N+bJEnNsUkS1M2ZTFIfZpIkdZlJktTM2U1S/2aSJDWbbJI0zZlMkgUqSTs2k5e0xJlMkuZsJklSM2cySZb5TNJM0hZmEkndmUlS/2aSJDVjJklSM2cySRanmSS1mMmS5L0ziZSbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabJpC5NJ3JtNktSMmUySJDdpktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabJpC5NJ3JtNktSMmUySJDdpktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabLpCpmExM8kSVIzZ5IkdZlJktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabJpC5NJ3JtNktSMmUySJDdpktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabLpCpmExM8kSVIzZ5IkdZlJktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabJpC5NJ3JtNktSMmUySJDdpktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabLpCpmExM8kSVIzZ5IkdZlJktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabJpC5NJ3JtNktSMmUySJDdpktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykySpxUyRpI5NJqXbTJJUYyZJUqibJUn9mU1S82aTJKiZM5kkS/wmabLpCpmExM8kSVIzZ5IkdZlJktTMmUySDWaS1GGmSFKZmSSpmTOTJDnsJEmqMZNkqJslSf2ZTVIzZpIkaZozmaQKlKT5mUlS92aSJDVjJklSM2cySbYykyQ9mclL2mJNJml+JlP9Jkmsa+7/LwRBEC9S/gM8wWJkCJJXxwAAAABJRU5ErkJggg=='; createElement('image', { src: nexiflowPNG, href: 'https://nexiflow.netlify.app', width: '60px', isNexiflow: true }); nexiflowIconAdded = true; updateDownloadButtonState(); });
            const selectElement = (element) => { if (selectedElement) selectedElement.classList.remove('selected'); selectedElement = element; selectedElement.classList.add('selected'); updatePropertiesPanel(); updateLayersPanel(); };
            const deselectAll = () => { if (selectedElement) selectedElement.classList.remove('selected'); selectedElement = null; propertiesPanel.classList.add('hidden'); updateLayersPanel(); };
            canvas.addEventListener('mousedown', (e) => { if (e.target === canvas) deselectAll(); });
            const updatePropertiesPanel = () => { if (!selectedElement) { propertiesPanel.classList.add('hidden'); return; } propertiesPanel.classList.remove('hidden'); commonProperties.classList.remove('hidden'); textProperties.classList.add('hidden'); imageProperties.classList.add('hidden'); const isLocked = selectedElement.dataset.locked === 'true'; lockText.textContent = isLocked ? 'Sblocca Elemento' : 'Blocca Elemento'; unlockIcon.classList.toggle('hidden', isLocked); lockIcon.classList.toggle('hidden', !isLocked); const type = selectedElement.dataset.type; if (type === 'text') { textProperties.classList.remove('hidden'); const textDiv = selectedElement.querySelector('div'); fontFamilySelect.value = textDiv.style.fontFamily; fontSizeInput.value = parseInt(textDiv.style.fontSize); fontColorInput.value = rgbToHex(textDiv.style.color); fontBoldBtn.classList.toggle('active', textDiv.style.fontWeight === 'bold'); fontItalicBtn.classList.toggle('active', textDiv.style.fontStyle === 'italic'); fontUnderlineBtn.classList.toggle('active', textDiv.style.textDecoration.includes('underline')); alignLeftBtn.classList.toggle('active', textDiv.style.textAlign === 'left' || !textDiv.style.textAlign); alignCenterBtn.classList.toggle('active', textDiv.style.textAlign === 'center'); alignRightBtn.classList.toggle('active', textDiv.style.textAlign === 'right'); textShadowCheckbox.checked = textDiv.style.textShadow !== 'none' && textDiv.style.textShadow !== ''; } else if (type === 'image') { imageProperties.classList.remove('hidden'); const link = selectedElement.querySelector('a'); const img = selectedElement.querySelector('img'); imageLinkInput.value = link ? link.href : ''; imageWidthInput.value = parseInt(img.style.width); imageOpacityInput.value = img.style.opacity || 1; } };
            fontFamilySelect.addEventListener('input', (e) => { if(selectedElement) selectedElement.querySelector('div').style.fontFamily = e.target.value; });
            fontSizeInput.addEventListener('input', (e) => { if(selectedElement) selectedElement.querySelector('div').style.fontSize = e.target.value + 'px'; });
            fontColorInput.addEventListener('input', (e) => { if(selectedElement) selectedElement.querySelector('div').style.color = e.target.value; });
            const toggleTextStyle = (style, value, defaultValue) => { if(!selectedElement) return; const textDiv = selectedElement.querySelector('div'); textDiv.style[style] = textDiv.style[style] === value ? defaultValue : value; updatePropertiesPanel(); };
            fontBoldBtn.addEventListener('click', () => toggleTextStyle('fontWeight', 'bold', 'normal'));
            fontItalicBtn.addEventListener('click', () => toggleTextStyle('fontStyle', 'italic', 'normal'));
            fontUnderlineBtn.addEventListener('click', () => { const textDiv = selectedElement.querySelector('div'); textDiv.style.textDecoration = textDiv.style.textDecoration.includes('underline') ? 'none' : 'underline'; updatePropertiesPanel(); });
            const setTextAlign = (align) => { if(selectedElement) selectedElement.querySelector('div').style.textAlign = align; updatePropertiesPanel(); }
            alignLeftBtn.addEventListener('click', () => setTextAlign('left'));
            alignCenterBtn.addEventListener('click', () => setTextAlign('center'));
            alignRightBtn.addEventListener('click', () => setTextAlign('right'));
            textShadowCheckbox.addEventListener('change', (e) => { if(selectedElement) selectedElement.querySelector('div').style.textShadow = e.target.checked ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none'; });
            imageLinkInput.addEventListener('input', (e) => { if(selectedElement) selectedElement.querySelector('a').href = e.target.value; });
            imageWidthInput.addEventListener('input', (e) => { if(selectedElement) selectedElement.querySelector('img').style.width = e.target.value + 'px'; });
            imageOpacityInput.addEventListener('input', (e) => { if(selectedElement) selectedElement.querySelector('img').style.opacity = e.target.value; });
            lockElementBtn.addEventListener('click', () => { if (!selectedElement) return; selectedElement.dataset.locked = !(selectedElement.dataset.locked === 'true'); updatePropertiesPanel(); });
            const updateLayersPanel = () => { layersPanel.innerHTML = ''; const elements = Array.from(canvas.children).reverse(); if(elements.length === 0) { layersPanel.innerHTML = '<p class="text-gray-400 text-sm">Aggiungi elementi per vederli qui.</p>'; return; } elements.forEach(el => { const item = document.createElement('div'); item.className = 'layer-item'; item.textContent = `${el.dataset.type.charAt(0).toUpperCase() + el.dataset.type.slice(1)} #${el.dataset.id.split('-')[1]}`; item.dataset.targetId = el.dataset.id; if(selectedElement && el.dataset.id === selectedElement.dataset.id) { item.classList.add('selected'); } item.addEventListener('click', () => { const target = document.querySelector(`[data-id="${el.dataset.id}"]`); selectElement(target); }); item.setAttribute('draggable', true); item.addEventListener('dragstart', (e) => e.target.classList.add('dragging')); item.addEventListener('dragend', (e) => e.target.classList.remove('dragging')); item.addEventListener('dragover', (e) => { e.preventDefault(); }); item.addEventListener('drop', (e) => { e.preventDefault(); const draggingItem = layersPanel.querySelector('.dragging'); const fromIndex = Array.from(layersPanel.children).indexOf(draggingItem); const toIndex = Array.from(layersPanel.children).indexOf(e.currentTarget); reorderElements(fromIndex, toIndex); }); layersPanel.appendChild(item); }); };
            const reorderElements = (fromIndex, toIndex) => { const elements = Array.from(canvas.children).reverse(); const [movedElement] = elements.splice(fromIndex, 1); elements.splice(toIndex, 0, movedElement); elements.reverse().forEach((el, index) => el.style.zIndex = index + 1); updateLayersPanel(); }
            const updateDownloadButtonState = () => { downloadBtn.disabled = !nexiflowIconAdded; nexiflowWarning.classList.toggle('hidden', nexiflowIconAdded); };
            downloadBtn.addEventListener('click', () => { modalFilename.textContent = `${channelName}.html`; downloadModal.classList.remove('hidden'); });
            cancelDownloadBtn.addEventListener('click', () => downloadModal.classList.add('hidden'));
            confirmDownloadBtn.addEventListener('click', () => { downloadModal.classList.add('hidden'); performDownload(); });
            aiTextBtn.addEventListener('click', () => aiTextModal.classList.remove('hidden'));
            closeAiTextModalBtn.addEventListener('click', () => aiTextModal.classList.add('hidden'));
            aiImageBtn.addEventListener('click', () => aiImageModal.classList.remove('hidden'));
            closeAiImageModalBtn.addEventListener('click', () => aiImageModal.classList.add('hidden'));
            const callGeminiWithExponentialBackoff = async (apiUrl, payload) => { let attempt = 0; const maxAttempts = 5; while (attempt < maxAttempts) { try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (response.ok) { return await response.json(); } if (response.status < 429) { console.error(`API Error: ${response.status} ${response.statusText}`); return null; } } catch (error) { console.error('Network or other error during fetch:', error); } const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000; await new Promise(resolve => setTimeout(resolve, delay)); attempt++; } console.error('API call failed after multiple retries.'); return null; };
            aiTextForm.addEventListener('submit', async (e) => { e.preventDefault(); const prompt = aiTextPrompt.value.trim(); if (!prompt) return; aiTextLoader.classList.remove('hidden'); aiTextError.classList.add('hidden'); aiTextForm.querySelector('button').disabled = true; const apiKey = "AIzaSyDVu3DX-481zjfm5gPPxHbaMYRVV1VCQvQ"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: prompt }] }], }; const result = await callGeminiWithExponentialBackoff(apiUrl, payload); if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) { const generatedText = result.candidates[0].content.parts[0].text; createElement('text', { text: generatedText }); aiTextModal.classList.add('hidden'); aiTextPrompt.value = ''; } else { aiTextError.textContent = 'Oops! Qualcosa è andato storto. Riprova.'; aiTextError.classList.remove('hidden'); } aiTextLoader.classList.add('hidden'); aiTextForm.querySelector('button').disabled = false; });
            aiImageForm.addEventListener('submit', async (e) => { e.preventDefault(); const prompt = aiImagePrompt.value.trim(); if (!prompt) return; aiImageLoader.classList.remove('hidden'); aiImageError.classList.add('hidden'); aiImageForm.querySelector('button').disabled = true; const apiKey = "AIzaSyDVu3DX-481zjfm5gPPxHbaMYRVV1VCQvQ"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`; const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } }; const result = await callGeminiWithExponentialBackoff(apiUrl, payload); if (result && result.predictions?.[0]?.bytesBase64Encoded) { const base64Image = result.predictions[0].bytesBase64Encoded; const imageUrl = `data:image/png;base64,${base64Image}`; createElement('image', { src: imageUrl, width: '300px' }); aiImageModal.classList.add('hidden'); aiImagePrompt.value = ''; } else { aiImageError.textContent = 'Oops! Qualcosa è andato storto. Riprova.'; aiImageError.classList.remove('hidden'); } aiImageLoader.classList.add('hidden'); aiImageForm.querySelector('button').disabled = false; });
            const performDownload = () => { deselectAll(); const canvasClone = canvas.cloneNode(true); const canvasWidth = canvas.offsetWidth; const canvasHeight = canvas.offsetHeight; Array.from(canvasClone.children).forEach(el => { el.classList.remove('selected', 'draggable'); el.querySelector('.resizer')?.remove(); el.querySelector('.quick-delete-btn')?.remove(); ['data-id', 'data-type', 'data-locked', 'data-nexiflow-icon', 'contenteditable'].forEach(attr => el.removeAttribute(attr)); const leftPx = parseFloat(el.style.left) || 0; const topPx = parseFloat(el.style.top) || 0; const widthPx = parseFloat(el.style.width) || 0; el.style.left = `${(leftPx / canvasWidth * 100).toFixed(2)}%`; el.style.top = `${(topPx / canvasHeight * 100).toFixed(2)}%`; if (widthPx > 0) { el.style.width = `${(widthPx / canvasWidth * 100).toFixed(2)}%`; } }); const finalHTML = `
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${channelName}</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Inter, sans-serif; }
        #container { width: 100%; height: 100%; position: relative; background-color: ${rgbToHex(canvas.style.backgroundColor) || 'white'}; ${canvas.style.backgroundImage ? `background-image: ${canvas.style.backgroundImage};` : ''} background-size: cover; background-position: center; overflow: hidden; }
        #container > div { position: absolute; box-sizing: border-box; }
        #container img, #container iframe { width: 100%; height: 100%; display: block; }
        #container a { text-decoration: none; color: inherit; display: block; width: 100%; height: 100%; }
        #container div > div { width: 100%; height: 100%; }
    </style>
</head>
<body><div id="container">${canvasClone.innerHTML}</div></body>
</html>`; const blob = new Blob([finalHTML.trim()], { type: 'text/html' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${channelName}.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const rgbToHex = (rgb) => { if (!rgb || !rgb.includes('rgb')) return rgb; let [r, g, b] = rgb.match(/\d+/g).map(Number); return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1); };
        });
    </script>
</body>
</html>