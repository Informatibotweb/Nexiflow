<!DOCTYPE html>
<html lang="it">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHXQ3M8FYD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BHXQ3M8FYD');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexiflow™ by Nexiquar</title>
  <link rel="icon" type="image/png" href="nexiflow.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800;900&display=swap');
    
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary-solid: #667eea;
      --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      
      --surface-1: rgba(255, 255, 255, 0.95);
      --surface-2: rgba(255, 255, 255, 0.85);
      --surface-3: rgba(255, 255, 255, 0.75);
      
      --text-1: #1a1a1a;
      --text-2: #4a4a4a;
      --text-3: #8a8a8a;
      
      --border: rgba(0, 0, 0, 0.08);
      --shadow-1: 0 2px 20px rgba(0, 0, 0, 0.08);
      --shadow-2: 0 8px 40px rgba(0, 0, 0, 0.12);
      --shadow-3: 0 20px 60px rgba(0, 0, 0, 0.15);
      
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-xl: 32px;
    }

    [data-theme="dark"] {
      --surface-1: rgba(20, 20, 20, 0.95);
      --surface-2: rgba(25, 25, 25, 0.85);
      --surface-3: rgba(30, 30, 30, 0.75);
      --text-1: #ffffff;
      --text-2: #b0b0b0;
      --text-3: #707070;
      --border: rgba(255, 255, 255, 0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-1);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .glass {
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: var(--surface-1);
      border: 1px solid var(--border);
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 16px 0;
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo { height: 36px; width: auto; }

    .brand {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-decoration: none;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-1);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-2); }

    .search-box {
      position: relative;
      min-width: 200px;
    }

    .search-input {
      width: 100%;
      padding: 10px 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-sm);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }

    .search-input::placeholder { color: rgba(255, 255, 255, 0.6); }

    /* Main Content */
    .main { margin-top: 80px; padding: 40px 0; min-height: calc(100vh - 80px); }

    .welcome {
      background: var(--surface-1);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-1);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: var(--shadow-1);
    }

    .welcome-text h2 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }
    .welcome-text p { color: var(--text-2); font-size: 16px; }
    .profile-link { 
      color: var(--primary-solid); 
      font-weight: 500; 
      cursor: pointer;
      text-decoration: underline;
    }

    /* Post Creator */
    .post-creator {
      background: var(--surface-1);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-1);
      display: none;
    }

    .post-creator.active { display: block; animation: slideIn 0.4s ease; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-types {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: var(--radius-sm);
    }

    .post-type {
      flex: 1;
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-2);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .post-type.active {
      background: white;
      color: var(--text-1);
      box-shadow: var(--shadow-1);
    }

    .form-group { margin-bottom: 16px; }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      color: var(--text-1);
      font-size: 16px;
      resize: vertical;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-solid);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .publish-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 16px;
    }

    .publish-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-2); }
    .publish-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Posts */
    .posts { display: flex; flex-direction: column; gap: 24px; }

    .post {
      background: var(--surface-1);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .post::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
    }

    .post:hover { transform: translateY(-4px); box-shadow: var(--shadow-2); }

    .post-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .author {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-1);
    }

    .author-avatar { width: 48px; height: 48px; }

    .author-info h4 { font-size: 16px; font-weight: 600; }
    .author-info p { font-size: 14px; color: var(--text-3); }
    .username-link {
      font-size: 12px;
      color: var(--primary-solid);
      cursor: pointer;
      text-decoration: underline;
    }

    .post-actions { display: flex; gap: 8px; }

    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 0, 0, 0.1);
      color: #ff4444;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .action-btn:hover { background: #ff4444; color: white; }

    .post-content { margin-bottom: 16px; font-size: 16px; line-height: 1.6; }

    .post-embed {
      border-radius: var(--radius-md);
      overflow: hidden;
      margin: 16px 0;
      box-shadow: var(--shadow-1);
    }

    .post-embed iframe { width: 100%; height: 400px; border: none; }
    .post-embed .vertical { height: 600px; max-width: 400px; margin: 0 auto; }

    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 16px;
    }

    .votes {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .vote-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      color: var(--text-2);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .vote-btn:hover { border-color: var(--primary-solid); color: var(--primary-solid); }

    .vote-count {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-1);
    }

    .post-btns { display: flex; gap: 8px; flex-wrap: wrap; }

    .post-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      color: var(--text-2);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .post-btn:hover { background: var(--primary-solid); color: white; }

    /* Auth */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-card {
      background: var(--surface-1);
      padding: 40px;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-3);
      width: 100%;
      max-width: 400px;
      backdrop-filter: blur(20px);
    }

    .auth-card h2 {
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 32px;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-form { display: flex; flex-direction: column; gap: 20px; }

    .auth-input {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      color: var(--text-1);
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--primary-solid);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .auth-btn {
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .auth-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-2); }

    .social-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      color: var(--text-1);
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .social-btn:hover { background: var(--surface-3); }

    .social-btn img { width: 20px; height: 20px; }

    /* Profile Pics */
    .profile-selector {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--surface-2);
      border-radius: var(--radius-sm);
    }

    .profile-option {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .profile-option:hover { transform: scale(1.05); }
    .profile-option.selected { border-color: var(--primary-solid); transform: scale(1.05); }

    /* Chat Interface */
    .chat-container {
      min-height: calc(100vh - 80px);
      display: flex;
      background: var(--surface-1);
      margin: 80px 20px 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      overflow: hidden;
    }

    .chat-sidebar {
      width: 300px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
    }

    .chat-header h3 { 
      font-size: 18px; 
      margin-bottom: 8px;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-item:hover, .chat-item.active {
      background: var(--surface-2);
    }

    .chat-item-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-item-info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chat-item-info p {
      font-size: 12px;
      color: var(--text-3);
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-conversation-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      word-wrap: break-word;
      position: relative;
    }

    .message.sent {
      background: var(--primary-solid);
      color: white;
      align-self: flex-end;
    }

    .message.received {
      background: var(--surface-2);
      color: var(--text-1);
      align-self: flex-start;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .chat-input-area {
      padding: 20px;
      border-top: 1px solid var(--border);
      background: var(--surface-2);
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-1);
      color: var(--text-1);
      font-size: 16px;
    }

    .send-btn {
      padding: 12px 20px;
      background: var(--primary-solid);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .send-btn:hover { background: #5a6fd8; }

    .no-chat-selected {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-3);
      font-size: 18px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .header-content { flex-wrap: wrap; gap: 12px; }
      .search-box { min-width: 150px; }
      .post { padding: 16px; }
      .post-footer { flex-direction: column; align-items: stretch; }
      .votes { justify-content: center; }
      .post-btns { justify-content: center; }
      
      .chat-container {
        margin: 80px 10px 10px;
        flex-direction: column;
      }
      
      .chat-sidebar {
        width: 100%;
        max-height: 300px;
      }
    }

    /* Utilities */
    .hidden { display: none !important; }
    .glass { backdrop-filter: blur(20px); }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Username generator styles */
    .username-preview {
      padding: 8px 12px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: var(--radius-sm);
      color: var(--primary-solid);
      font-weight: 600;
      font-family: monospace;
      text-align: center;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <script src="https://accounts.google.com/gsi/client" defer async></script>
  
  <!-- Auth Content -->
  <div id="authContent">
    <div id="loginPage">
      <div class="auth-container">
        <div class="auth-card glass">
          <h2>Accedi a Nexiflow</h2>
          <div class="auth-form">
            <input type="email" id="loginEmail" class="auth-input" placeholder="Email" />
            <input type="password" id="loginPassword" class="auth-input" placeholder="Password" />
            <button onclick="login()" class="auth-btn">Accedi</button>
            
            <div style="text-align: center; color: var(--text-3); margin: 16px 0;">o</div>
            
            <div id="g_id_onload" data-client_id="744167679001-old6qgj92p1mpgrgps0ju6sdh5gb8c47.apps.googleusercontent.com" data-callback="handleGoogle"></div>
            <div class="g_id_signin" data-type="standard"></div>
            
            <button onclick="loginSpotify()" class="social-btn">
              <img src="https://www.scdn.co/i/_global/favicon.png" alt="Spotify" />
              Accedi con Spotify
            </button>
          </div>
          
          <div style="text-align: center; margin-top: 20px;">
            Non hai un account? <a href="#" onclick="showRegister()" style="color: var(--primary-solid);">Registrati</a>
          </div>
        </div>
      </div>
    </div>

    <div id="registerPage" class="hidden">
      <div class="auth-container">
        <div class="auth-card glass">
          <h2>Registrati su Nexiflow</h2>
          <div class="auth-form">
            <input type="text" id="regName" class="auth-input" placeholder="Nome" oninput="generateUsername()" />
            <div class="username-preview" id="usernamePreview">@username00</div>
            <input type="email" id="regEmail" class="auth-input" placeholder="Email" />
            <input type="password" id="regPassword" class="auth-input" placeholder="Password" />
            
            <label style="font-weight: 500;">Scegli un'immagine profilo:</label>
            <div class="profile-selector" id="regProfileSelector">
              <img src="profilo1.png" class="profile-option selected" data-value="profilo1.png" onclick="selectProfile(this)">
              <img src="profilo2.png" class="profile-option" data-value="profilo2.png" onclick="selectProfile(this)">
              <img src="profilo3.png" class="profile-option" data-value="profilo3.png" onclick="selectProfile(this)">
              <img src="profilo4.png" class="profile-option" data-value="profilo4.png" onclick="selectProfile(this)">
            </div>
            
            <button onclick="register()" class="auth-btn">Registrati con LinkLoopChat™</button>
          </div>
          
          <div style="text-align: center; margin-top: 20px;">
            Hai già un account? <a href="#" onclick="showLogin()" style="color: var(--primary-solid);">Accedi</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App Content -->
  <div id="appContent" class="hidden">
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo-section">
            <img class="logo" src="logo1.png" alt="Logo">
            <a href="#" class="brand" onclick="showMain()">Nexiflow</a>
          </div>
          
          <div class="search-box">
            <input type="text" class="search-input" placeholder="Cerca @username..." id="searchInput" />
          </div>
          
          <div class="header-actions">
            <button class="btn btn-ghost" onclick="showChats()">💬 LinkLoopChat™</button>
            <button class="btn btn-ghost" onclick="showVideos()">🎬 Video</button>
            <button class="btn btn-primary" onclick="toggleCreator()">➕ Nuovo Post</button>
            <button class="btn btn-ghost" onclick="showSettings()">⚙️</button>
            <button class="btn btn-ghost" onclick="toggleTheme()">🌗</button>
            <button class="btn btn-ghost" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Feed -->
    <div id="mainView">
      <div class="container">
        <div class="main">
          <div class="welcome">
            <img class="avatar" id="userAvatar" src="" alt="Avatar">
            <div class="welcome-text">
              <h2 id="userName">Benvenuto</h2>
              <p>Il tuo profilo: <span class="profile-link" id="userProfileLink" onclick="copyProfileLink()">@username00</span></p>
              <p id="linkLoopStatus" style="font-size: 12px; color: var(--text-3); margin-top: 4px;"></p>
            </div>
          </div>

          <!-- Post Creator -->
          <div class="post-creator" id="postCreator">
            <div class="post-types">
              <button class="post-type active" onclick="setType('text', this)">Testo</button>
              <button class="post-type" onclick="setType('video', this)">Video</button>
              <button class="post-type" onclick="setType('embed', this)">Embed</button>
              <button class="post-type" onclick="setType('twitter', this)">Twitter</button>
            </div>
            
            <div id="textFields">
              <div class="form-group">
                <textarea class="form-input" id="postText" rows="3" placeholder="Cosa stai pensando?"></textarea>
              </div>
            </div>
            
            <div id="videoFields" class="hidden">
              <div class="form-group">
                <textarea class="form-input" id="videoDesc" rows="2" placeholder="Descrizione video..."></textarea>
              </div>
              <div class="form-group">
                <input type="url" class="form-input" id="videoLink" placeholder="Link video (YouTube, etc.)">
              </div>
            </div>
            
            <div id="embedFields" class="hidden">
              <div class="form-group">
                <textarea class="form-input" id="embedCode" rows="4" placeholder="Codice embed (iframe)..."></textarea>
              </div>
            </div>
            
            <div id="twitterFields" class="hidden">
              <div class="form-group">
                <input type="url" class="form-input" id="twitterLink" placeholder="Link post Twitter/X">
              </div>
            </div>
            
            <button class="publish-btn" id="publishBtn" onclick="publish()" disabled>Pubblica</button>
          </div>

          <!-- Posts -->
          <div class="posts" id="postsContainer"></div>
        </div>
      </div>
    </div>

    <!-- Chat View -->
    <div id="chatView" class="hidden">
      <div class="chat-container">
        <div class="chat-sidebar">
          <div class="chat-header">
            <h3>LinkLoopChat™</h3>
            <p style="font-size: 12px; color: var(--text-3);">Messaggistica sicura by Nexiquar™</p>
          </div>
          <div class="chat-list" id="chatList">
            <div style="padding: 20px; text-align: center; color: var(--text-3);">
              Nessuna conversazione attiva
            </div>
          </div>
        </div>
        <div class="chat-main">
          <div class="no-chat-selected" id="noChatSelected">
            Seleziona una conversazione per iniziare a chattare
          </div>
          <div id="chatConversation" class="hidden">
            <div class="chat-conversation-header">
              <img class="chat-item-avatar" id="currentChatAvatar" src="" alt="">
              <div>
                <h4 id="currentChatName"></h4>
                <p id="currentChatUsername" style="font-size: 12px; color: var(--text-3);"></p>
              </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="chatMessageInput" placeholder="Scrivi un messaggio..." />
              <button class="send-btn" onclick="sendChatMessage()">Invia</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configurazione API
    const API_KEY = "$2a$10$KNFCGq2q1AWerjl1Jhy/hOdyDhPwIGGztn7zrkggd3vU5dFiGdvLe";
    const BINS = {
      posts: "68960092f7e7a370d1f76798",
      videos: "689600c7f7e7a370d1f767d7", 
      users: "68c57e9cd0ea881f407cb920", // Nuovo bin per utenti con username
      messages: "68c8103ed0ea881f407e9c06", // Nuovo bin per messaggi LinkLoopChat
      oldUsers: "68580aba8a456b7966b3543a", // Bin originale per compatibilità
      oldMessages: "689600f3203a8b52b5e1dafd" // Bin originale per compatibilità
    };
    
    const headers = { "Content-Type": "application/json", "X-Master-Key": API_KEY };
    const spotifyClientId = 'f77ae12dd0e7405192d95390c8b1b418';
    const redirectUri = 'https://nexiflow.netlify.app';

    // Variabili globali
    let currentUser = null;
    let nexiquarUser = null; // Utente autenticato Nexiquar per LinkLoopChat
    let allPosts = [], allVideos = [], allUsers = [], allMessages = {};
    let nexiquarUsers = []; // Utenti del sistema Nexiquar
    let currentType = 'text', currentFormat = 'horizontal';
    let currentChatUser = null;
    let currentView = 'main';

    // Utility functions
    const $ = id => document.getElementById(id);
    const show = id => $(id).classList.remove('hidden');
    const hide = id => $(id).classList.add('hidden');
    const toggle = id => $(id).classList.toggle('hidden');

    // API functions con nuovo bin Nexiquar
    const api = {
      async get(bin) {
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${BINS[bin]}/latest`, { headers });
          const data = await res.json();
          return data.record;
        } catch (error) {
          console.error(`Error fetching ${bin}:`, error);
          return { users: [], posts: [], videos: [], messages: {} };
        }
      },
      async put(bin, data) {
        return fetch(`https://api.jsonbin.io/v3/b/${BINS[bin]}`, {
          method: 'PUT', 
          headers, 
          body: JSON.stringify(data)
        });
      },
      // Carica utenti Nexiquar dal bin specifico
      async getNexiquarUsers() {
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/68c57e9cd0ea881f407cb920/latest`, { headers });
          const data = await res.json();
          return data.record.users || data.record || [];
        } catch (error) {
          console.error('Error fetching Nexiquar users:', error);
          return [];
        }
      },
      // Salva nuovo utente Nexiquar
      async addNexiquarUser(userData) {
        try {
          nexiquarUsers.push(userData);
          return fetch(`https://api.jsonbin.io/v3/b/68c57e9cd0ea881f407cb920`, {
            method: 'PUT',
            headers,
            body: JSON.stringify(nexiquarUsers.length > 1 ? { users: nexiquarUsers } : nexiquarUsers)
          });
        } catch (error) {
          console.error('Error saving Nexiquar user:', error);
        }
      }
    };

    // Username generation
    function generateUsername() {
      const name = $('regName').value.trim().toLowerCase();
      if (!name) {
        $('usernamePreview').textContent = '@username00';
        return;
      }
      
      const cleanName = name.replace(/[^a-z]/g, '');
      const randomNum = Math.floor(Math.random() * 90) + 10;
      const username = `@${cleanName}${randomNum}`;
      $('usernamePreview').textContent = username;
    }

    function copyProfileLink() {
      // Rimuovo la funzione link profilo perché non può funzionare senza routing server-side
      alert(`Il tuo username è: ${currentUser.username}\n\nCondividi il tuo username per far trovare il tuo profilo!`);
    }

    // Load data con caricamento utenti Nexiquar
    async function loadData() {
      try {
        const [posts, videos, users, messages, nexiquarUsersData] = await Promise.all([
          api.get('posts'),
          api.get('videos'), 
          api.get('users'),
          api.get('messages'),
          api.getNexiquarUsers()
        ]);
        
        allPosts = posts.posts || [];
        allVideos = videos.videos || [];
        allUsers = users.users || [];
        allMessages = messages.conversations || {};
        nexiquarUsers = Array.isArray(nexiquarUsersData) ? nexiquarUsersData : (nexiquarUsersData.users || []);
        
        console.log('Data loaded:', { 
          posts: allPosts.length, 
          users: allUsers.length, 
          nexiquarUsers: nexiquarUsers.length 
        });
        
        if (currentView === 'main') {
          renderPosts();
        } else if (currentView === 'chat') {
          renderChatList();
        }
      } catch (err) {
        console.error('Load error:', err);
      }
    }

    // Auth functions
    function showLogin() { 
      show('loginPage'); 
      hide('registerPage'); 
    }
    
    function showRegister() { 
      hide('loginPage'); 
      show('registerPage'); 
      generateUsername();
    }

    function selectProfile(el) {
      el.parentNode.querySelectorAll('.profile-option').forEach(p => p.classList.remove('selected'));
      el.classList.add('selected');
    }

    async function register() {
      const name = $('regName').value.trim();
      const email = $('regEmail').value.trim();
      const password = $('regPassword').value.trim();
      const pic = document.querySelector('#regProfileSelector .selected').dataset.value;
      const username = $('usernamePreview').textContent;

      if (!name || !email || !password) {
        alert('Compila tutti i campi!');
        return;
      }

      // Controlla se email o username esistono già
      if (allUsers.find(u => u.email === email)) {
        alert('Email già registrata!');
        return;
      }

      if (allUsers.find(u => u.username === username)) {
        alert('Username già in uso, prova a cambiare nome!');
        generateUsername();
        return;
      }

      const newUser = { 
        name, 
        email, 
        password, 
        profilePic: pic, 
        bio: '',
        username: username,
        joinDate: new Date().toISOString()
      };

      allUsers.push(newUser);
      await api.put('users', { users: allUsers });
      
      // Salva nel localStorage
      localStorage.setItem('nexiflow_userEmail', email);
      localStorage.setItem('nexiflow_loginType', 'nexiflow');
      
      alert('Registrazione completata con LinkLoopChat™!');
      showLogin();
    }

    async function login() {
      const email = $('loginEmail').value.trim();
      const password = $('loginPassword').value.trim();
      
      if (!email || !password) {
        alert('Inserisci email e password!');
        return;
      }

      const user = allUsers.find(u => u.email === email);

      if (!user) {
        alert('Utente non trovato!');
        return;
      }
      
      if (user.password !== password) {
        alert('Password errata!');
        return;
      }

      currentUser = user;
      localStorage.setItem('nexiflow_userEmail', email);
      localStorage.setItem('nexiflow_loginType', 'nexiflow');
      
      showApp();
    }

    function logout() {
      currentUser = null;
      nexiquarUser = null;
      localStorage.removeItem('nexiflow_userEmail');
      localStorage.removeItem('nexiflow_loginType');
      localStorage.removeItem('nexiflow_nexiquarEmail');
      localStorage.removeItem('nexiflow_nexiquarAuth');
      showAuth();
    }

    // Google Auth
    function handleGoogle(response) {
      const token = parseJwt(response.credential);
      let user = allUsers.find(u => u.email === token.email);
      
      if (!user) {
        // Genera username per utenti Google
        const cleanName = token.name.toLowerCase().replace(/[^a-z]/g, '');
        const randomNum = Math.floor(Math.random() * 90) + 10;
        const username = `@${cleanName}${randomNum}`;
        
        user = { 
          name: token.name, 
          email: token.email, 
          profilePic: token.picture, 
          bio: 'Google user',
          username: username,
          joinDate: new Date().toISOString()
        };
        allUsers.push(user);
        api.put('users', { users: allUsers });
      }
      
      currentUser = user;
      localStorage.setItem('nexiflow_userEmail', user.email);
      localStorage.setItem('nexiflow_loginType', 'google');
      showApp();
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (error) {
        console.error('JWT parsing error:', error);
        throw error;
      }
    }

    // Spotify Auth
    function loginSpotify() {
      const scope = 'user-read-private user-read-email';
      const url = `https://accounts.spotify.com/authorize?client_id=${spotifyClientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}`;
      window.location.href = url;
    }

    // Navigation
    function showAuth() { 
      show('authContent'); 
      hide('appContent'); 
      showLogin(); 
    }

    function showApp() { 
      hide('authContent');
      show('appContent');
      
      if (currentUser) {
        $('userName').textContent = currentUser.name;
        $('userAvatar').src = currentUser.profilePic;
        $('userProfileLink').textContent = currentUser.username;
        
        // Mostra stato LinkLoopChat
        const linkLoopStatus = $('linkLoopStatus');
        if (linkLoopUser) {
          linkLoopStatus.textContent = '✅ LinkLoopChat™ attivo - Chat disponibili';
          linkLoopStatus.style.color = 'green';
        } else {
          linkLoopStatus.textContent = '⚠️ LinkLoopChat™ non attivo - Accedi per usare la chat';
          linkLoopStatus.style.color = 'orange';
        }
        
        showMain();
      } else {
        showAuth();
      }
    }

    function showMain() {
      currentView = 'main';
      show('mainView');
      hide('chatView');
      renderPosts();
    }

    function showChats() {
      // Controlla se l'utente è loggato su Nexiflow
      if (!currentUser) {
        alert('Devi effettuare il login per accedere alle funzionalità di Nexiflow');
        showAuth();
        return;
      }

      // Controlla se l'utente ha accesso Nexiquar per LinkLoopChat
      if (!nexiquarUser) {
        showNexiquarAuth();
        return;
      }

      currentView = 'chat';
      hide('mainView');
      show('chatView');
      renderChatList();
    }

    // Nexiquar Authentication per LinkLoopChat
    function showNexiquarAuth() {
      const modal = $('nexiquarAuthModal');
      modal.classList.add('active');
      modal.style.display = 'flex';
    }

    function closeNexiquarModal() {
      const modal = $('nexiquarAuthModal');
      modal.classList.remove('active');
      modal.style.display = 'none';
    }

    function redirectToNexiquarRegistration() {
      // Apri la pagina di registrazione Nexiquar in una nuova finestra
      window.open('https://nexiquarmail.wuaze.com', '_blank');
      
      // Chiudi il modal
      closeNexiquarModal();
      
      // Mostra messaggio informativo
      setTimeout(() => {
        alert('Dopo la registrazione su nexiquarmail.wuaze.com, potrai utilizzare le tue credenziali Nexiquar per accedere a LinkLoopChat™.');
      }, 1000);
    }

    async function loginNexiquar() {
      const email = $('nexiquarEmail').value.trim();
      const password = $('nexiquarPassword').value.trim();
      
      if (!email || !password) {
        alert('Inserisci email e password Nexiquar™!');
        return;
      }

      // Verifica che l'email sia @nexiquar.nx
      if (!email.endsWith('@nexiquar.nx')) {
        alert('Puoi accedere solo con un account @nexiquar.nx');
        return;
      }

      // Cerca l'utente nel bin Nexiquar
      const nexiquarUser_found = nexiquarUsers.find(u => 
        u.email === email && u.password === password
      );

      if (!nexiquarUser_found) {
        // Se non trovato, mostra messaggio di registrazione
        if (confirm('Account non trovato. Vuoi registrarti su Nexiquar™?')) {
          redirectToNexiquarRegistration();
        }
        return;
      }

      // Login riuscito
      nexiquarUser = {
        nome: nexiquarUser_found.nome,
        cognome: nexiquarUser_found.cognome,
        email: nexiquarUser_found.email,
        nexiquarVerified: true,
        loginDate: new Date().toISOString()
      };
      
      // Salva nel localStorage
      localStorage.setItem('nexiflow_nexiquarEmail', email);
      localStorage.setItem('nexiflow_nexiquarAuth', 'true');
      
      closeNexiquarModal();
      alert(`Benvenuto in LinkLoopChat™, ${nexiquarUser_found.nome}!`);
      
      // Apri automaticamente la chat
      showChats();
    }

    function checkNexiquarAuth() {
      const nexiquarEmail = localStorage.getItem('nexiflow_nexiquarEmail');
      const nexiquarAuth = localStorage.getItem('nexiflow_nexiquarAuth');
      
      if (nexiquarEmail && nexiquarAuth === 'true') {
        // Ricontrolla nel database
        const foundUser = nexiquarUsers.find(u => u.email === nexiquarEmail);
        if (foundUser) {
          nexiquarUser = {
            nome: foundUser.nome,
            cognome: foundUser.cognome,
            email: foundUser.email,
            nexiquarVerified: true,
            loginDate: new Date().toISOString()
          };
          return true;
        }
      }
      return false;
    }

    function showVideos() { 
      alert('Sezione Video - Funzionalità in sviluppo');
    }

    function showSettings() {
      if (!currentUser) return;
      
      const newName = prompt('Nuovo nome:', currentUser.name);
      const newBio = prompt('Nuova bio:', currentUser.bio || '');
      
      if (newName && newName !== currentUser.name) {
        const oldUsername = currentUser.username;
        currentUser.name = newName;
        
        // Rigenera username se il nome cambia
        const cleanName = newName.toLowerCase().replace(/[^a-z]/g, '');
        const randomNum = Math.floor(Math.random() * 90) + 10;
        const newUsername = `@${cleanName}${randomNum}`;
        
        // Verifica che il nuovo username non esista
        if (!allUsers.find(u => u.username === newUsername && u.email !== currentUser.email)) {
          currentUser.username = newUsername;
        }
        
        updateUserData();
        $('userName').textContent = currentUser.name;
        $('userProfileLink').textContent = currentUser.username;
        alert('Nome e username aggiornati!');
      }
      
      if (newBio !== null && newBio !== currentUser.bio) {
        currentUser.bio = newBio;
        updateUserData();
        alert('Bio aggiornata!');
      }
    }

    async function updateUserData() {
      const userIndex = allUsers.findIndex(u => u.email === currentUser.email);
      if (userIndex !== -1) {
        allUsers[userIndex] = currentUser;
        await api.put('users', { users: allUsers });
      }
    }

    // Theme toggle
    function toggleTheme() {
      const currentTheme = document.body.dataset.theme || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.body.dataset.theme = newTheme;
      localStorage.setItem('nexiflow_theme', newTheme);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('nexiflow_theme') || 'light';
      document.body.dataset.theme = savedTheme;
    }

    // Post creation
    function toggleCreator() { 
      $('postCreator').classList.toggle('active'); 
    }

    function setType(type, btn) {
      currentType = type;
      document.querySelectorAll('.post-type').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      ['textFields', 'videoFields', 'embedFields', 'twitterFields'].forEach(id => hide(id));
      show(type + 'Fields');
      checkPublishBtn();
    }

    function setFormat(format) {
      currentFormat = format;
      document.querySelectorAll('#embedFields .post-type').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    }

    function checkPublishBtn() {
      const inputs = { text: 'postText', video: 'videoLink', embed: 'embedCode', twitter: 'twitterLink' };
      const hasContent = $(inputs[currentType])?.value.trim();
      $('publishBtn').disabled = !hasContent;
    }

    async function publish() {
      if (!currentUser) {
        alert('Devi effettuare il login per pubblicare!');
        return;
      }

      const inputs = {
        text: () => ({ content: $('postText').value, description: $('postText').value }),
        video: () => ({ content: $('videoLink').value, description: $('videoDesc').value }),
        embed: () => ({ content: $('embedCode').value, description: $('embedDesc').value }),
        twitter: () => ({ content: $('twitterLink').value, description: '' })
      };

      const data = inputs[currentType]();
      if (!data.content.trim()) return;

      const post = {
        id: Date.now(),
        author: currentUser.name,
        authorEmail: currentUser.email,
        authorUsername: currentUser.username,
        authorPic: currentUser.profilePic,
        type: currentType,
        ...data,
        date: new Date().toLocaleString('it-IT'),
        upvotes: 0,
        downvotes: 0,
        comments: [],
        embedFormat: currentFormat
      };

      allPosts.unshift(post);
      await api.put('posts', { posts: allPosts });
      renderPosts();
      
      // Clear form
      ['postText', 'videoDesc', 'videoLink', 'embedDesc', 'embedCode', 'twitterLink']
        .forEach(id => $(id) && ($(id).value = ''));
      toggleCreator();
      checkPublishBtn();
    }

    // Post rendering
    function renderPosts() {
      const container = $('postsContainer');
      if (!container) return;
      
      container.innerHTML = '';

      allPosts.forEach(post => {
        const isOwner = currentUser && post.authorEmail === currentUser.email;
        const deleteBtn = isOwner ? `<button class="action-btn" onclick="deletePost(${post.id})">❌</button>` : '';
        const msgBtn = !isOwner && currentUser ? `<button class="post-btn" onclick="startChatFromPost('${post.authorEmail}')">✉️ Messaggio</button>` : '';
        const usernameDisplay = post.authorUsername || '@unknown';

        let content = '';
        if (post.type === 'text') {
          content = `<div class="post-content">${post.content}</div>`;
        } else if (post.type === 'video') {
          content = `
            ${post.description ? `<div class="post-content">${post.description}</div>` : ''}
            <div class="post-embed">
              <iframe src="${getEmbedUrl(post.content)}"></iframe>
            </div>`;
        } else if (post.type === 'embed') {
          const cls = post.embedFormat === 'vertical' ? 'vertical' : '';
          content = `
            ${post.description ? `<div class="post-content">${post.description}</div>` : ''}
            <div class="post-embed">
              <iframe class="${cls}" src="${getEmbedSrc(post.content)}"></iframe>
            </div>`;
        } else if (post.type === 'twitter') {
          content = `<blockquote class="twitter-tweet"><a href="${post.content}"></a></blockquote>`;
        }

        const postEl = document.createElement('div');
        postEl.className = 'post fade-in';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="author" onclick="showProfile('${post.authorEmail}')">
              <img src="${post.authorPic}" class="author-avatar avatar">
              <div class="author-info">
                <h4>${post.author}</h4>
                <div class="username-link">${usernameDisplay}</div>
                <p>${post.date}</p>
              </div>
            </div>
            <div class="post-actions">
              ${deleteBtn}
            </div>
          </div>
          ${content}
          <div class="post-footer">
            <div class="votes">
              <button class="vote-btn" onclick="vote(${post.id}, 'up')">👍 ${post.upvotes || 0}</button>
              <div class="vote-count">${(post.upvotes || 0) - (post.downvotes || 0)}</div>
              <button class="vote-btn" onclick="vote(${post.id}, 'down')">👎 ${post.downvotes || 0}</button>
            </div>
            <div class="post-btns">
              <button class="post-btn" onclick="toggleComments(${post.id})">💬 Commenti (${post.comments ? post.comments.length : 0})</button>
              ${msgBtn}
            </div>
          </div>
        `;
        container.appendChild(postEl);

        if (post.type === 'twitter') {
          const script = document.createElement('script');
          script.src = 'https://platform.twitter.com/widgets.js';
          document.body.appendChild(script);
        }
      });
    }

    function getEmbedUrl(url) {
      if (url.includes('youtu.be')) return `https://www.youtube.com/embed/${url.split('youtu.be/')[1].split('?')[0]}`;
      if (url.includes('youtube.com')) return `https://www.youtube.com/embed/${new URL(url).searchParams.get('v')}`;
      return url;
    }

    function getEmbedSrc(code) {
      const doc = new DOMParser().parseFromString(code, 'text/html');
      const iframe = doc.querySelector('iframe');
      return iframe?.src || '';
    }

    async function vote(id, type) {
      if (!currentUser) {
        alert('Devi effettuare il login per votare!');
        return;
      }

      const post = allPosts.find(p => p.id === id);
      if (!post) return;
      
      post[type === 'up' ? 'upvotes' : 'downvotes'] = (post[type === 'up' ? 'upvotes' : 'downvotes'] || 0) + 1;
      await api.put('posts', { posts: allPosts });
      renderPosts();
    }

    async function deletePost(id) {
      const post = allPosts.find(p => p.id === id);
      if (!post || post.authorEmail !== currentUser.email) return;
      
      if (confirm('Sei sicuro di voler eliminare questo post?')) {
        allPosts = allPosts.filter(p => p.id !== id);
        await api.put('posts', { posts: allPosts });
        renderPosts();
      }
    }

    function showProfile(email) {
      const user = allUsers.find(u => u.email === email);
      if (!user) return;
      
      if (user.email === currentUser?.email) {
        showSettings();
        return;
      }
      
      const profileInfo = `
Profilo: ${user.username}
Nome: ${user.name}
Bio: ${user.bio || 'Nessuna bio disponibile'}

Cosa vuoi fare?
1. Invia messaggio con LinkLoopChat™
2. Visualizza i suoi post
3. Chiudi
      `;
      
      const choice = prompt(profileInfo);
      
      if (choice === '1') {
        if (!currentUser) {
          alert('Devi effettuare il login per inviare messaggi!');
          showAuth();
          return;
        }
        startChat(user);
      } else if (choice === '2') {
        showUserPosts(user);
      }
    }

    function showUserPosts(user) {
      const userPosts = allPosts.filter(p => p.authorEmail === user.email);
      if (userPosts.length === 0) {
        alert('Questo utente non ha ancora pubblicato post.');
        return;
      }
      
      const postsInfo = userPosts.slice(0, 5).map((post, i) => 
        `${i + 1}. ${post.type === 'text' ? post.content.substring(0, 50) + '...' : `[${post.type.toUpperCase()}] ${post.description || 'Senza descrizione'}`} (${post.date})`
      ).join('\n');
      
      alert(`Ultimi post di ${user.name} (${user.username}):\n\n${postsInfo}${userPosts.length > 5 ? '\n\n...e altri ' + (userPosts.length - 5) + ' post' : ''}`);
    }

    function toggleComments(postId) {
      if (!currentUser) {
        alert('Devi effettuare il login per commentare!');
        return;
      }

      const post = allPosts.find(p => p.id === postId);
      if (!post) return;
      
      if (!post.comments || post.comments.length === 0) {
        const comment = prompt('Scrivi un commento:');
        if (!comment || !comment.trim()) return;
        
        if (!post.comments) post.comments = [];
        post.comments.push({
          author: currentUser.name,
          authorEmail: currentUser.email,
          authorUsername: currentUser.username,
          text: comment.trim(),
          date: new Date().toLocaleString('it-IT')
        });
        
        api.put('posts', { posts: allPosts });
        alert('Commento aggiunto!');
        renderPosts();
      } else {
        const commentsText = post.comments.map(c => 
          `${c.author} (${c.authorUsername || '@unknown'}): ${c.text} (${c.date})`
        ).join('\n\n');
        
        const action = prompt(`Commenti (${post.comments.length}):\n\n${commentsText}\n\nScrivi "nuovo" per aggiungere un commento o premi Annulla:`);
        
        if (action && action.toLowerCase() === 'nuovo') {
          const newComment = prompt('Scrivi un commento:');
          if (newComment && newComment.trim()) {
            post.comments.push({
              author: currentUser.name,
              authorEmail: currentUser.email,
              authorUsername: currentUser.username,
              text: newComment.trim(),
              date: new Date().toLocaleString('it-IT')
            });
            
            api.put('posts', { posts: allPosts });
            alert('Commento aggiunto!');
            renderPosts();
          }
        }
      }
    }

    // Chat functions
    function renderChatList() {
      const chatList = $('chatList');
      if (!chatList || !currentUser) return;

      // Ottieni tutte le conversazioni dell'utente corrente
      const userConversations = Object.keys(allMessages).filter(key => 
        key.includes(currentUser.email)
      );

      if (userConversations.length === 0) {
        chatList.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-3);">
            <p>Nessuna conversazione attiva</p>
            <p style="font-size: 12px; margin-top: 8px;">Inizia una chat cliccando "Messaggio" su un post!</p>
          </div>
        `;
        return;
      }

      chatList.innerHTML = '';
      
      userConversations.forEach(conversationId => {
        const otherUserEmail = conversationId.split('_to_').find(email => email !== currentUser.email);
        const otherUser = allUsers.find(u => u.email === otherUserEmail);
        
        if (!otherUser) return;

        const messages = allMessages[conversationId] || [];
        const lastMessage = messages[messages.length - 1];

        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.onclick = () => selectChat(otherUser);
        
        chatItem.innerHTML = `
          <img src="${otherUser.profilePic}" class="chat-item-avatar" alt="${otherUser.name}">
          <div class="chat-item-info">
            <h4>${otherUser.name}</h4>
            <p>${otherUser.username}</p>
            ${lastMessage ? `<p style="font-size: 11px; margin-top: 2px;">${lastMessage.text.substring(0, 30)}${lastMessage.text.length > 30 ? '...' : ''}</p>` : ''}
          </div>
        `;
        
        chatList.appendChild(chatItem);
      });
    }

    function selectChat(user) {
      currentChatUser = user;
      
      // Aggiorna header della conversazione
      $('currentChatName').textContent = user.name;
      $('currentChatUsername').textContent = user.username;
      $('currentChatAvatar').src = user.profilePic;
      
      // Mostra conversazione e nascondi messaggio vuoto
      hide('noChatSelected');
      show('chatConversation');
      
      // Evidenzia chat selezionata
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      event.target.closest('.chat-item')?.classList.add('active');
      
      renderChatMessages();
    }

    function renderChatMessages() {
      const messagesContainer = $('chatMessages');
      if (!messagesContainer || !currentChatUser) return;

      const conversationId = getConversationId(currentUser.email, currentChatUser.email);
      const messages = allMessages[conversationId] || [];

      messagesContainer.innerHTML = '';

      if (messages.length === 0) {
        const welcomeMsg = document.createElement('div');
        welcomeMsg.style.textAlign = 'center';
        welcomeMsg.style.color = 'var(--text-3)';
        welcomeMsg.style.padding = '20px';
        welcomeMsg.innerHTML = `
          <p>Inizia una conversazione con ${currentChatUser.name}!</p>
          <p style="font-size: 12px; margin-top: 8px;">Powered by LinkLoopChat™</p>
        `;
        messagesContainer.appendChild(welcomeMsg);
        return;
      }

      messages.forEach(message => {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.senderEmail === currentUser.email ? 'sent' : 'received'}`;
        
        messageEl.innerHTML = `
          <div>${message.text}</div>
          <div class="message-time">${new Date(message.timestamp).toLocaleString('it-IT')}</div>
        `;
        
        messagesContainer.appendChild(messageEl);
      });

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function getConversationId(email1, email2) {
      return [email1, email2].sort().join('_to_');
    }

    function startChat(user) {
      // Controlla se l'utente è loggato su Nexiflow
      if (!currentUser) {
        alert('Devi effettuare il login per utilizzare la messaggistica');
        showAuth();
        return;
      }

      // Controlla se l'utente ha accesso Nexiquar
      if (!nexiquarUser) {
        showNexiquarAuth();
        return;
      }

      showChats();
      setTimeout(() => selectChat(user), 100);
    }

    function startChatFromPost(email) {
      // Controlla se l'utente è loggato su Nexiflow
      if (!currentUser) {
        alert('Devi effettuare il login per utilizzare la messaggistica');
        showAuth();
        return;
      }

      // Controlla se l'utente ha accesso Nexiquar
      if (!nexiquarUser) {
        showNexiquarAuth();
        return;
      }

      const user = allUsers.find(u => u.email === email);
      if (user) {
        startChat(user);
      }
    }

    async function sendChatMessage() {
      const input = $('chatMessageInput');
      const text = input.value.trim();
      
      if (!text || !currentChatUser || !currentUser) return;

      const conversationId = getConversationId(currentUser.email, currentChatUser.email);
      
      if (!allMessages[conversationId]) {
        allMessages[conversationId] = [];
      }

      const message = {
        senderEmail: currentUser.email,
        senderName: currentUser.name,
        text: text,
        timestamp: new Date().toISOString()
      };

      allMessages[conversationId].push(message);
      
      // Salva nel nuovo bin per i messaggi
      await api.put('messages', { conversations: allMessages });
      
      input.value = '';
      renderChatMessages();
      renderChatList(); // Aggiorna la lista per mostrare il nuovo ultimo messaggio
    }

    // Search functionality
    function setupSearch() {
      const searchInput = $('searchInput');
      if (!searchInput) return;

      searchInput.addEventListener('input', e => {
        const query = e.target.value.toLowerCase().trim();
        
        if (query.length < 2) {
          hideSearchResults();
          return;
        }

        let matches = [];
        
        // Cerca per username (con o senza @)
        if (query.startsWith('@')) {
          matches = allUsers.filter(u => 
            u.username && u.username.toLowerCase().includes(query.toLowerCase())
          );
        } else {
          // Cerca per nome o username
          matches = allUsers.filter(u => 
            u.name.toLowerCase().includes(query) || 
            (u.username && u.username.toLowerCase().includes('@' + query))
          );
        }

        showSearchResults(matches);
      });
    }

    function showSearchResults(matches) {
      let resultsDiv = $('searchResults');
      
      if (!resultsDiv) {
        resultsDiv = document.createElement('div');
        resultsDiv.id = 'searchResults';
        resultsDiv.style.cssText = `
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: var(--surface-1);
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          box-shadow: var(--shadow-2);
          z-index: 1000;
          max-height: 300px;
          overflow-y: auto;
        `;
        $('searchInput').parentNode.style.position = 'relative';
        $('searchInput').parentNode.appendChild(resultsDiv);
      }

      if (matches.length === 0) {
        resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-3);">Nessun utente trovato</div>';
        resultsDiv.style.display = 'block';
        return;
      }

      resultsDiv.innerHTML = '';
      resultsDiv.style.display = 'block';

      matches.forEach(user => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 12px;
          cursor: pointer;
          border-bottom: 1px solid var(--border);
          display: flex;
          align-items: center;
          gap: 12px;
          transition: background 0.2s;
        `;
        
        item.innerHTML = `
          <img src="${user.profilePic}" style="width: 32px; height: 32px; border-radius: 50%;">
          <div>
            <div style="font-weight: 500;">${user.name}</div>
            <div style="font-size: 12px; color: var(--primary-solid);">${user.username}</div>
          </div>
        `;
        
        item.addEventListener('mouseover', () => item.style.background = 'var(--surface-2)');
        item.addEventListener('mouseout', () => item.style.background = 'transparent');
        item.addEventListener('click', () => {
          showProfile(user.email);
          hideSearchResults();
          $('searchInput').value = '';
        });
        
        resultsDiv.appendChild(item);
      });
    }

    function hideSearchResults() {
      const results = $('searchResults');
      if (results) results.style.display = 'none';
    }

    // URL handling for profile links
    function handleProfileUrl() {
      const path = window.location.pathname;
      if (path && path !== '/') {
        const username = path.substring(1); // Remove leading slash
        
        // Cerca utente per username
        const user = allUsers.find(u => u.username === '@' + username || u.username === username);
        
        if (user) {
          // Mostra profilo dell'utente
          setTimeout(() => {
            showProfile(user.email);
          }, 1000);
        } else {
          console.log('Profile not found for:', username);
        }
      }
    }

    // Event listeners
    function setupEventListeners() {
      // Chat input enter key
      const chatInput = $('chatMessageInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', e => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });
      }

      // Form validation
      const inputIds = ['postText', 'videoLink', 'embedCode', 'twitterLink'];
      inputIds.forEach(id => {
        const el = $(id);
        if (el) el.addEventListener('input', checkPublishBtn);
      });

      // Close search results when clicking outside
      document.addEventListener('click', e => {
        if (!e.target.closest('.search-box')) {
          hideSearchResults();
        }
      });

      // Name input for username generation
      const regName = $('regName');
      if (regName) {
        regName.addEventListener('input', generateUsername);
      }
    }

    // Auto-login check
    async function checkAutoLogin() {
      const storedEmail = localStorage.getItem('nexiflow_userEmail');
      const loginType = localStorage.getItem('nexiflow_loginType');
      
      if (!storedEmail) {
        showAuth();
        return;
      }

      // Cerca l'utente nel database
      const user = allUsers.find(u => u.email === storedEmail);
      
      if (user) {
        currentUser = user;
        console.log('Auto-login successful for:', user.name, user.username);
        showApp();
      } else {
        // Rimuovi dati di login non validi
        localStorage.removeItem('nexiflow_userEmail');
        localStorage.removeItem('nexiflow_loginType');
        showAuth();
      }
    }

    // Spotify auth check
    async function handleSpotifyAuth() {
      const params = new URLSearchParams(location.hash.substring(1));
      const token = params.get('access_token');
      
      if (!token) return false;

      try {
        const res = await fetch('https://api.spotify.com/v1/me', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const spotifyUser = await res.json();
        
        let user = allUsers.find(u => u.email === spotifyUser.email);
        
        if (!user) {
          // Genera username per utenti Spotify
          const cleanName = spotifyUser.display_name.toLowerCase().replace(/[^a-z]/g, '');
          const randomNum = Math.floor(Math.random() * 90) + 10;
          const username = `@${cleanName}${randomNum}`;
          
          user = {
            name: spotifyUser.display_name,
            email: spotifyUser.email,
            profilePic: spotifyUser.images[0]?.url || 'profilo1.png',
            bio: 'Spotify user',
            username: username,
            joinDate: new Date().toISOString()
          };
          allUsers.push(user);
          await api.put('users', { users: allUsers });
        }
        
        currentUser = user;
        localStorage.setItem('nexiflow_userEmail', user.email);
        localStorage.setItem('nexiflow_loginType', 'spotify');
        
        // Rimuovi parametri URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        showApp();
        return true;
      } catch (err) {
        console.error('Spotify auth error:', err);
        return false;
      }
    }

    // Initialize application
    window.onload = async () => {
      console.log('Nexiflow initializing...');
      
      // Load theme first
      loadTheme();
      
      // Load data from APIs
      await loadData();
      
      // Setup event listeners
      setupEventListeners();
      setupSearch();
      
      // Check for Spotify authentication
      const spotifyAuthHandled = await handleSpotifyAuth();
      
      if (!spotifyAuthHandled) {
        // Check for auto-login
        await checkAutoLogin();
      }
      
      // Handle profile URL if present
      handleProfileUrl();
      
      console.log('Nexiflow initialized successfully');
    };

    // Utility functions for backward compatibility
    function migrateOldUserData() {
      // Questa funzione può essere usata per migrare dati dai bin precedenti
      // se necessario in futuro
    }

    // Development helpers
    window.nexiflowDebug = {
      currentUser: () => currentUser,
      linkLoopUser: () => linkLoopUser,
      allUsers: () => allUsers,
      allMessages: () => allMessages,
      resetLogin: () => {
        localStorage.removeItem('nexiflow_userEmail');
        localStorage.removeItem('nexiflow_loginType');
        localStorage.removeItem('nexiflow_linkLoopEmail');
        localStorage.removeItem('nexiflow_linkLoopAuth');
        location.reload();
      },
      forceLinkLoopLogin: () => {
        linkLoopUser = { email: 'test@linkloop.com', linkLoopVerified: true };
        localStorage.setItem('nexiflow_linkLoopEmail', 'test@linkloop.com');
        localStorage.setItem('nexiflow_linkLoopAuth', 'true');
        showApp();
      }
    };

    console.log('Nexiflow Enhanced loaded - Nexiquar™ LinkLoopChat™ integration ready!');

    console.log('Nexiflow Enhanced loaded - Profile links & LinkLoopChat™ ready!');
  </script>
</body>
</html>dDesc" rows="2" placeholder="Descrizione..."></textarea>
              </div>
              <div class="post-types">
                <button class="post-type active" onclick="setFormat('horizontal')">Normale</button>
                <button class="post-type" onclick="setFormat('vertical')">Short/Reel</button>
              </div>
              <div class="form-group">
                <textarea class="form-input" id="embe
