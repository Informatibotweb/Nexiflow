<!DOCTYPE html>
<html lang="it">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHXQ3M8FYD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BHXQ3M8FYD');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexiflow‚Ñ¢ by Nexiquar</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');

    :root {
      --bg-light: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      --text-light: #111;
      --card-light: #ffffff;
      --bg-dark: linear-gradient(135deg, #1e1e1e, #0c0c0c);
      --text-dark: #f0f0f0;
      --card-dark: #2a2a2a;
      --primary: #4CAF50;
      --secondary: #2196F3;
      --accent: #ff416c;
      --border-radius: 20px;
      --spacing: 1rem;
    }

    body {
      margin: 0;
      font-family: 'Quicksand', sans-serif;
      transition: background 0.5s ease, color 0.5s ease;
      background: var(--bg-light);
      color: var(--text-light);
      line-height: 1.6;
    }

    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: var(--spacing);
    }
    
    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing) 2rem;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      opacity: 0;
      animation: fadeIn 1s forwards;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-bottom: var(--spacing);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    h1 {
      font-size: 2.5rem;
      border-radius: 50px;
      padding: 0.5rem 1rem;
      background-color: var(--primary);
      color: white;
      font-family: 'Roboto Mono', monospace;
      transform: scale(0);
      animation: popIn 0.5s forwards 0.5s;
    }
    
    @keyframes popIn {
        to { transform: scale(1); }
    }

    button {
      padding: 0.7rem 1.2rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-family: 'Quicksand', sans-serif;
      font-weight: bold;
      transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
    }

    button:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    body.dark-mode button:hover {
        box-shadow: 0 5px 20px rgba(255,255,255,0.1);
    }

    .theme-toggle {
      background: #ddd;
      font-size: 1.5rem;
    }

    .header-buttons {
      display: flex;
      gap: 15px;
    }
    
    .add-button, .change-name-header, .video-button, .logout-button, .settings-button, .channels-button {
      background: var(--primary);
      color: white;
      font-size: 1rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 0.5rem;
        background: rgba(0,0,0,0.05);
        border-radius: var(--border-radius);
    }
    
    .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    #logo {
        height: 100px;
        width: auto;
        transition: opacity 0.5s;
    }
    
    #searchArea {
        position: relative;
        margin-left: auto;
    }
    
    #searchInput {
        padding: 0.7rem 1.2rem;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: var(--border-radius);
        background: rgba(255, 255, 255, 0.5);
        transition: width 0.3s ease;
        width: 150px;
        color: var(--text-light);
    }
    
    #searchInput:focus {
        width: 250px;
        outline: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    body.dark-mode #searchInput {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-dark);
    }
    
    #searchResults {
        position: absolute;
        top: 100%;
        right: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: var(--card-light);
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 10;
        display: none;
    }
    
    body.dark-mode #searchResults {
        background: var(--card-dark);
        border-color: #555;
    }
    
    .search-result-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        color: inherit;
    }
    
    .search-result-item:hover {
        background-color: #f0f0f0;
    }
    
    body.dark-mode .search-result-item:hover {
        background-color: #3b3b3b;
    }
    
    .search-result-item img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    
    .search-result-item.channel-result .channel-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--secondary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .input-area {
      display: none;
      padding: 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-direction: column;
      gap: 1rem;
      border-radius: var(--border-radius);
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .input-area.active {
      display: flex;
      animation: slideDown 0.5s forwards;
    }

    @keyframes slideDown {
        from { transform: translateY(-30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    #postText, #userName, .video-input, .embed-input, #newVideoDescription, #newVideoEmbedCode, #twitterLink {
      padding: 1rem;
      font-size: 1.1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      background: rgba(0,0,0,0.1);
      color: inherit;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    #postText:focus, #userName:focus, .video-input:focus, .embed-input:focus, #newVideoDescription:focus, #newVideoEmbedCode:focus, #twitterLink:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent);
    }

    #publishBtn:disabled, #publishVideoBtn:disabled {
      background-color: #555;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .post-type-selector, .video-format-selector, .video-type-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .post-type-selector button.active, .video-format-selector button.active, .video-type-selector button.active {
        background: var(--accent);
        color: white;
    }
    
    .post-type-fields {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .post-embed {
      margin-top: 20px;
      display: flex;
      justify-content: center;
    }
    
    .post-embed iframe {
        width: 100%;
        max-width: 720px;
        height: 405px;
        border: none;
        border-radius: var(--border-radius);
    }

    /* Stili per video Shorts incorporati */
    .post-embed .vertical-video {
        width: 100%;
        max-width: 405px;
        height: 720px;
    }
    
    .posts {
      padding: 2rem;
    }

    .post {
      background-color: var(--card-light);
      padding: 2rem;
      margin-bottom: 2rem;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      position: relative;
      transition: transform 0.5s ease, box-shadow 0.5s ease;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .post-header .user-link, .post-header .channel-link {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: inherit;
        font-weight: bold;
    }
    
    .post-header .channel-link .channel-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--secondary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .post-header .profile-pic {
        width: 40px;
        height: 40px;
    }
    
    body.dark-mode .post {
      background-color: var(--card-dark);
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .post:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    
    body.dark-mode .post:hover {
      box-shadow: 0 15px 40px rgba(255,255,255,0.1);
    }
    
    .post-actions {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        gap: 10px;
    }
    
    .post-actions button {
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 8px 12px;
        border-radius: 50%;
        font-size: 1.2rem;
        line-height: 1;
        transition: transform 0.3s ease, background-color 0.3s ease;
    }

    .post-actions button:hover {
        transform: scale(1.2) translateY(-2px);
        background-color: var(--accent);
    }

    .date {
      font-size: 1rem;
      margin-top: 1rem;
      color: #999;
    }
    
    .post-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        position: relative;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .vote-buttons {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .vote-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.5rem;
        transition: transform 0.2s;
    }

    .vote-btn:hover {
        transform: scale(1.3);
    }

    .vote-btn:active {
        transform: scale(0.9);
    }
    
    .vote-count {
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0 5px;
    }

    .comment-btn, .delete-btn {
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
    }

    .comment-btn {
      background-color: var(--secondary);
      color: white;
    }

    .delete-btn {
      background-color: #d32f2f;
      color: white;
    }
    
    .comments-section {
        margin-top: 1.5rem;
        border-top: 1px solid #ddd;
        padding-top: 1.5rem;
    }
    
    .comment-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .comment {
        background-color: #f9f9f9;
        padding: 1rem;
        border-radius: 15px;
        font-size: 1rem;
        word-wrap: break-word;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    body.dark-mode .comment {
        background-color: #3b3b3b;
        box-shadow: 0 2px 10px rgba(255,255,255,0.05);
    }
    
    .comment-form {
        display: flex;
        margin-top: 1.5rem;
        gap: 1rem;
    }
    
    .comment-input {
        flex-grow: 1;
        padding: 1rem;
        border-radius: var(--border-radius);
        border: 1px solid #aaa;
        background-color: rgba(0,0,0,0.1);
        color: inherit;
    }
    
    .comment-input:focus {
        outline: none;
        border-color: var(--secondary);
    }
    
    .comment-submit-btn {
        padding: 1rem 1.5rem;
        background-color: var(--secondary);
        color: white;
        border-radius: var(--border-radius);
    }

    footer {
      display: flex;
      justify-content: center;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
      margin-top: 3rem;
      border-radius: var(--border-radius);
      font-size: 1rem;
      padding: 2rem;
    }
    
    .emoji-rain-up, .emoji-rain-down {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    }
    
    .emoji {
        position: absolute;
        font-size: 2rem;
        opacity: 0;
        text-shadow: 0 0 5px white;
    }
    
    @keyframes fly-up {
        from { transform: translateY(0) scale(1); opacity: 1; }
        to { transform: translateY(-150px) scale(2); opacity: 0; }
    }
    
    @keyframes fly-down {
        from { transform: translateY(0) scale(1); opacity: 1; }
        to { transform: translateY(150px) scale(0.5); opacity: 0; }
    }
    
    /* Stili per la finestra modale */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.95);
        animation: fadeInModal 0.3s forwards;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        position: relative;
        margin: auto;
        padding: 30px;
        width: 90%;
        max-width: 1200px;
        background-color: var(--card-dark);
        border-radius: var(--border-radius);
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
    }
    
    /* Stile di base per iframe nella modale */
    .modal-content iframe {
        width: 100%;
        height: 80vh; 
        max-height: 1000px;
        border: none;
        border-radius: var(--border-radius);
    }

    /* Stile specifico per i video orizzontali (16:9) */
    .modal-content .horizontal-video {
        aspect-ratio: 16 / 9;
        max-width: 100%;
        width: auto;
    }
    
    /* Stile specifico per i video verticali (Shorts) */
    .modal-content .vertical-video {
        aspect-ratio: 9 / 16;
        height: 100%;
        max-height: 80vh;
        width: auto;
    }
    
    .close-modal {
        position: absolute;
        top: 20px;
        right: 40px;
        color: #f1f1f1;
        font-size: 50px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
    }
    
    .close-modal:hover {
        color: var(--accent);
    }
    
    @keyframes fadeInModal {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Stili per la pagina dei video */
    #videoPage {
        display: none;
        padding: 2rem;
    }

    .video-page-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 2rem;
    }
    
    .video-page-header .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .video-type-selector {
        display: flex;
        gap: 15px;
    }
    
    #videoGrid {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        justify-content: center;
        padding-top: 2rem;
    }
    
    #videoGrid.shorts-grid {
        justify-content: flex-start;
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 3rem;
        white-space: nowrap;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }

    #videoGrid.shorts-grid .video-page-item {
      flex: 0 0 auto;
      width: 350px; /* Larghezza fissa per gli shorts */
      scroll-snap-align: center;
      height: 600px;
    }
    
    .video-page-item {
        background-color: var(--card-light);
        border-radius: var(--border-radius);
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        transition: transform 0.5s ease, box-shadow 0.5s ease;
    }
    
    body.dark-mode .video-page-item {
      background-color: var(--card-dark);
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    .video-page-item:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    
    body.dark-mode .video-page-item:hover {
      box-shadow: 0 15px 40px rgba(255,255,255,0.1);
    }
    
    .video-page-item .video-content {
        cursor: pointer;
    }
    
    .video-page-item iframe {
        width: 100%;
        height: 250px; 
        border: none;
    }

    .video-page-item .vertical-video {
        aspect-ratio: 9 / 16;
        height: auto;
        max-height: 600px;
    }

    .video-page-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 10px;
        z-index: 10;
    }
    
    .video-page-actions button {
        background-color: rgba(0,0,0,0.6);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        font-size: 1.2rem;
    }
    
    /* Stili per le interazioni nella sezione video */
    .video-item-footer {
        padding: 1.5rem;
    }

    .video-item-footer .vote-buttons {
        margin-top: 1.5rem;
    }
    
    /* Nuovo stile per il blocco dei pulsanti */
    .post-action-buttons {
        display: flex;
        gap: 10px;
    }

    /* === RESPONSIVE DESIGN === */

    @media (max-width: 768px) {
        body {
            font-size: 0.9rem;
        }
        
        .container {
            padding: var(--spacing);
        }

        header {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
            padding: var(--spacing);
        }
        
        #searchInput {
            width: 100%;
        }

        .header-buttons {
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        
        #logo {
            height: 70px;
        }
        
        h1 {
            font-size: 1.8rem;
            padding: 0.3rem 0.8rem;
        }
        
        .input-area, .posts, #videoPage {
            padding: var(--spacing);
        }
        
        .post, .video-page-item, .modal-content {
            padding: var(--spacing);
        }
        
        .post-type-selector, .video-format-selector, .video-type-selector {
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .post-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .comment-form {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .comment-submit-btn {
            width: 100%;
        }
        
        #videoGrid {
            gap: 1rem;
        }

        .video-page-header .header-row {
            flex-direction: column;
            gap: 1rem;
        }
        
        #videoGrid.shorts-grid {
            justify-content: center;
            padding-bottom: 2rem;
        }

        #videoGrid.shorts-grid .video-page-item {
            width: 100%;
            max-width: 300px;
            height: 500px;
        }

        .modal-content {
            padding: 15px;
        }

        .modal-content .horizontal-video {
            height: auto;
        }

        .modal-content .vertical-video {
            height: 80vh;
            width: auto;
            max-width: 100%;
        }
    }

    /* Stili per la nuova pagina utente */
    #userProfilePage, #channelPage, #channelsPage {
        display: none;
        padding: 2rem;
    }

    .profile-info {
        text-align: center;
        margin-bottom: 2rem;
        background-color: var(--card-light);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }
    
    .channel-info {
        text-align: center;
        margin-bottom: 2rem;
        background-color: var(--card-light);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    body.dark-mode .profile-info, body.dark-mode .channel-info {
        background-color: var(--card-dark);
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .profile-info img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 1rem;
    }
    
    .profile-info h2, .channel-info h2 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .profile-info p, .channel-info p {
        font-size: 1.1rem;
        color: #666;
    }
    
    body.dark-mode .profile-info p, body.dark-mode .channel-info p {
        color: #ccc;
    }
    
    .profile-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    .user-posts-list .post, .user-videos-list .video-page-item {
        margin-bottom: 1.5rem;
    }
    
    #userPostsContainer, #userVideosContainer {
        display: flex;
        flex-direction: column;
    }

    #registerPage, #loginPage {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
    }

    .auth-card {
        background-color: var(--card-light);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 100%;
        max-width: 400px;
    }

    body.dark-mode .auth-card {
        background-color: var(--card-dark);
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .auth-card input, .auth-card select, .auth-card textarea {
        padding: 0.8rem;
        font-size: 1rem;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 10px;
        background: rgba(0,0,0,0.05);
        color: inherit;
    }
    
    body.dark-mode .auth-card input, body.dark-mode .auth-card select, body.dark-mode .auth-card textarea {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .auth-card h2 {
        text-align: center;
        margin-bottom: 0;
    }
    
    /* Stili per la pagina impostazioni */
    #settingsPage {
        display: none;
        padding: 2rem;
    }

    #settingsForm {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background-color: var(--card-light);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }
    
    body.dark-mode #settingsForm {
        background-color: var(--card-dark);
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    .profile-pic-selector {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
    }
    
    .profile-pic-selector img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: border-color 0.3s, transform 0.2s;
    }
    
    .profile-pic-selector img:hover {
        transform: scale(1.1);
        border-color: var(--primary);
    }

    .profile-pic-selector img.selected {
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent);
        transform: scale(1.1);
    }

    /* Stili per la pagina dei canali */
    #channelsPage {
        display: none;
        padding: 2rem;
    }
    
    .channels-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 2rem;
    }

    .channel-card {
        background-color: var(--card-light);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    
    body.dark-mode .channel-card {
        background-color: var(--card-dark);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .channel-card:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .channel-card h3 {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .channel-card p {
        font-size: 0.9rem;
        color: #777;
    }
    
    body.dark-mode .channel-card p {
        color: #bbb;
    }
    
    .channel-card .channel-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--secondary);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    /* Stili per la pagina del singolo canale */
    #channelPage .channel-info .channel-icon {
        width: 80px;
        height: 80px;
        font-size: 3rem;
        margin-bottom: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: var(--secondary);
        color: white;
    }
    
    .channel-admin-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 2rem;
    }
    
    .channel-admin-buttons button {
        background: var(--accent);
        color: white;
    }
    
    .channel-posts-container {
        margin-top: 2rem;
    }
    
    .channel-admin-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    
    .channel-admin-section input {
        width: 100%;
        padding: 0.5rem;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin-top: 10px;
    }
    
    .input-area-destination {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .input-area-destination select {
        flex-grow: 1;
        padding: 0.7rem;
        border-radius: var(--border-radius);
        border: 1px solid rgba(0,0,0,0.2);
    }
    
  </style>
</head>
<body>
  <div class="container">
    
    <div id="authContent">
        <div id="loginPage">
            <div class="auth-card">
                <h2>Accedi</h2>
                <input type="text" id="loginEmail" placeholder="Email" />
                <input type="password" id="loginPassword" placeholder="Password" />
                <button onclick="loginUser()">Accedi</button>
                <p>Non hai un account? <a href="#" onclick="showRegisterPage()">Registrati</a></p>
            </div>
        </div>

        <div id="registerPage" style="display: none;">
            <div class="auth-card">
                <h2>Registrati</h2>
                <input type="text" id="registerName" placeholder="Nome" />
                <input type="email" id="registerEmail" placeholder="Email" />
                <input type="password" id="registerPassword" placeholder="Password" />
                <label for="profilePicSelector">Scegli un'immagine profilo:</label>
                <div class="profile-pic-selector" id="registerProfilePicSelector">
                    <img src="profilo1.png" data-value="profilo1.png" onclick="selectProfilePic(this, 'register')">
                    <img src="profilo2.png" data-value="profilo2.png" onclick="selectProfilePic(this, 'register')">
                    <img src="profilo3.png" data-value="profilo3.png" onclick="selectProfilePic(this, 'register')">
                    <img src="profilo4.png" data-value="profilo4.png" onclick="selectProfilePic(this, 'register')">
                </div>
                <button onclick="registerUser()">Registrati</button>
                <p>Hai gi√† un account? <a href="#" onclick="showLoginPage()">Accedi</a></p>
            </div>
        </div>
    </div>
    
    <div id="appContent" style="display: none;">
        <header>
            <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
            <img id="logo" src="logo1.png" alt="Nexiflow Logo">
            <div class="header-buttons">
                <button class="channels-button" onclick="showChannelsPage()"># Canali</button>
                <button class="video-button" onclick="showVideoPage()">üé¨ Video</button>
                <button class="add-button" onclick="showMainContent(); toggleInput()">‚ûï</button>
                <div id="searchArea">
                    <input type="text" id="searchInput" placeholder="Cerca utenti/canali..." />
                    <div id="searchResults"></div>
                </div>
                <button class="settings-button" onclick="showSettingsPage()">‚öôÔ∏è</button>
                <button class="logout-button" onclick="logoutUser()">Logout</button>
            </div>
        </header>

        <div id="welcomeMessage" class="user-info">
            <img id="userProfilePic" class="profile-pic" />
            <span id="userNameDisplay"></span>
        </div>
        
        <div class="input-area" id="inputArea">
            <div class="input-area-destination">
                <label for="postDestination">Pubblica su:</label>
                <select id="postDestination">
                    <option value="main">Bacheca Principale</option>
                </select>
            </div>
            
            <div class="post-type-selector">
                <button id="post-type-text" class="active" onclick="setPostType('text', this)">Testo</button>
                <button id="post-type-video" onclick="setPostType('video', this)">Video (solo link)</button>
                <button id="post-type-embed" onclick="setPostType('embed', this)">Incorpora (iframe)</button>
                <button id="post-type-twitter" onclick="setPostType('twitter', this)">Twitter (X)</button>
            </div>

            <div id="post-text-fields" class="post-type-fields">
                <input type="text" id="postText" placeholder="Scrivi testo o emoji..." />
            </div>
            <div id="post-video-fields" class="post-type-fields" style="display:none;">
                <input type="text" id="videoDescription" placeholder="Scrivi una descrizione per il video..." />
                <input type="text" id="videoLink" class="video-input" placeholder="Incolla il link del video (es. YouTube)..."/>
            </div>
            <div id="post-embed-fields" class="post-type-fields" style="display:none;">
                <input type="text" id="embedDescription" placeholder="Scrivi una descrizione per il video..." />
                <div class="video-format-selector">
                    <button id="embed-format-horizontal" class="active" onclick="setVideoFormat('horizontal')">Video Normale</button>
                    <button id="embed-format-vertical" onclick="setVideoFormat('vertical')">Short/Reel</button>
                </div>
                <textarea id="embedCode" class="embed-input" rows="4" placeholder="Incolla qui il codice di incorporazione (iframe)..."></textarea>
            </div>
            <div id="post-twitter-fields" class="post-type-fields" style="display:none;">
                <input type="text" id="twitterLink" placeholder="Incolla qui il link del post (es. https://x.com/...)" />
            </div>

            <button id="publishBtn" onclick="publishPost()" disabled>Pubblica su Nexiflow</button>
        </div>

        <div id="mainContent">
            <div class="posts" id="postsContainer"></div>
        </div>

        <div id="videoPage">
            <div class="video-page-header">
                <div class="header-row">
                    <button onclick="showMainContent()">‚Üê Torna alla bacheca</button>
                    <div class="video-type-selector">
                        <button id="video-type-shorts" class="active" onclick="showVideos('vertical', this)">Shorts / Reels</button>
                        <button id="video-type-normal" onclick="showVideos('horizontal', this)">Video Normali</button>
                    </div>
                    <button onclick="toggleVideoInput()">‚ûï Aggiungi Video</button>
                </div>
            </div>
            <div id="videoInputArea" class="input-area">
                <div class="post-type-fields">
                    <input type="text" id="newVideoDescription" placeholder="Scrivi una descrizione per il video..." />
                    <div class="video-format-selector">
                        <button id="new-video-format-horizontal" class="active" onclick="setNewVideoFormat('horizontal')">Video Normale</button>
                        <button id="new-video-format-vertical" onclick="setNewVideoFormat('vertical')">Short/Reel</button>
                    </div>
                    <textarea id="newVideoEmbedCode" class="embed-input" rows="4" placeholder="Incolla qui il link o il codice di incorporazione (iframe)..."></textarea>
                </div>
                <button id="publishVideoBtn" onclick="publishNewVideo()" disabled>Pubblica Video</button>
            </div>
            <div class="video-page-container" id="videoGrid"></div>
        </div>

        <div id="userProfilePage">
            <button onclick="showMainContent()">‚Üê Torna alla bacheca</button>
            <div class="profile-info" id="profileInfo"></div>
            <div class="profile-content">
                <div>
                    <h3>Post di questo utente:</h3>
                    <div class="posts user-posts-list" id="userPostsContainer"></div>
                </div>
                <div>
                    <h3>Video di questo utente:</h3>
                    <div class="video-page-container user-videos-list" id="userVideosContainer"></div>
                </div>
            </div>
        </div>

        <div id="channelsPage">
            <div class="header-row">
                <button onclick="showMainContent()">‚Üê Torna alla bacheca</button>
                <button onclick="showCreateChannelForm()">‚ûï Crea un nuovo canale</button>
            </div>
            
            <div id="createChannelForm" class="input-area">
                <input type="text" id="newChannelName" placeholder="Nome del canale" />
                <textarea id="newChannelDescription" rows="3" placeholder="Descrizione del canale..."></textarea>
                <button onclick="createChannel()">Crea Canale</button>
            </div>
            
            <h3>Tutti i canali</h3>
            <div class="channels-grid" id="channelsGrid"></div>
        </div>
        
        <div id="channelPage">
            <button onclick="showChannelsPage()">‚Üê Torna ai canali</button>
            <div class="channel-info" id="channelInfo"></div>
            <div class="channel-posts-container" id="channelPostsContainer"></div>
        </div>

        <div id="settingsPage">
            <button onclick="showMainContent()">‚Üê Torna alla bacheca</button>
            <h3>Modifica Profilo</h3>
            <div id="settingsForm" class="auth-card">
                <label for="editName">Nome:</label>
                <input type="text" id="editName" />
                <label for="editProfilePic">Immagine Profilo:</label>
                <div class="profile-pic-selector" id="settingsProfilePicSelector">
                    <img src="profilo1.png" data-value="profilo1.png" onclick="selectProfilePic(this, 'settings')">
                    <img src="profilo2.png" data-value="profilo2.png" onclick="selectProfilePic(this, 'settings')">
                    <img src="profilo3.png" data-value="profilo3.png" onclick="selectProfilePic(this, 'settings')">
                    <img src="profilo4.png" data-value="profilo4.png" onclick="selectProfilePic(this, 'settings')">
                </div>
                <label for="editBio">Bio:</label>
                <textarea id="editBio" rows="4"></textarea>
                <button onclick="saveSettings()">Salva Modifiche</button>
            </div>
        </div>
    </div>
    
    <footer>
        ¬© 2025 Nexiflow‚Ñ¢ - by Nexiquar - Tutti i diritti riservati
    </footer>
  </div>

  <div id="videoModal" class="modal">
    <span class="close-modal" onclick="closeModal()">√ó</span>
    <div class="modal-content">
        <div id="modalVideoContainer"></div>
    </div>
  </div>

<script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<script>
// Inserisci qui le tue API KEY e i BIN ID.
const API_KEY = "$2a$10$KNFCGq2q1AWerjl1Jhy/hOdyDhPwIGGztn7zrkggd3vU5dFiGdvLe";
const BIN_ID = "67fe4e4f8a456b796689d908";
const VIDEO_BIN_ID = "689076be7b4b8670d8acc5b2";
const USER_BIN_ID = "687ac68274f7b01b5c73cedf";
const CHANNEL_BIN_ID = "6891ad147b4b8670d8ad87a0";
const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const VIDEO_URL = `https://api.jsonbin.io/v3/b/${VIDEO_BIN_ID}`;
const USER_URL = `https://api.jsonbin.io/v3/b/${USER_BIN_ID}`;
const CHANNEL_URL = `https://api.jsonbin.io/v3/b/${CHANNEL_BIN_ID}`;

const headers = {
  "Content-Type": "application/json",
  "X-Master-Key": API_KEY
};

const registerNameInput = document.getElementById("registerName");
const registerEmailInput = document.getElementById("registerEmail");
const registerPasswordInput = document.getElementById("registerPassword");
const loginEmailInput = document.getElementById("loginEmail");
const loginPasswordInput = document.getElementById("loginPassword");
const appContent = document.getElementById("appContent");
const authContent = document.getElementById("authContent");
const loginPage = document.getElementById("loginPage");
const registerPage = document.getElementById("registerPage");
const postText = document.getElementById("postText");
const publishBtn = document.getElementById("publishBtn");
const welcomeMessage = document.getElementById("welcomeMessage");
const postsContainer = document.getElementById("postsContainer");
const logoElement = document.getElementById("logo");
const postTypeButtons = document.querySelectorAll('.post-type-selector button');
const textFields = document.getElementById('post-text-fields');
const videoFields = document.getElementById('post-video-fields');
const embedFields = document.getElementById('post-embed-fields');
const twitterFields = document.getElementById('post-twitter-fields');
const videoLinkInput = document.getElementById('videoLink');
const embedCodeInput = document.getElementById('embedCode');
const twitterLinkInput = document.getElementById('twitterLink');
const videoDescriptionInput = document.getElementById('videoDescription');
const embedDescriptionInput = document.getElementById('embedDescription');
const embedFormatButtons = document.querySelectorAll('.video-format-selector button');
const videoPage = document.getElementById('videoPage');
const mainContent = document.getElementById('mainContent');
const videoGrid = document.getElementById('videoGrid');
const videoTypeButtons = document.querySelectorAll('.video-page-header .video-type-selector button');
const videoInputArea = document.getElementById('videoInputArea');
const newVideoDescriptionInput = document.getElementById('newVideoDescription');
const newVideoEmbedCodeInput = document.getElementById('newVideoEmbedCode');
const newVideoFormatButtons = document.querySelectorAll('#videoInputArea .video-format-selector button');
const publishVideoBtn = document.getElementById('publishVideoBtn');
const userProfilePage = document.getElementById('userProfilePage');
const profileInfoDiv = document.getElementById('profileInfo');
const userPostsContainer = document.getElementById('userPostsContainer');
const userVideosContainer = document.getElementById('userVideosContainer');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const settingsPage = document.getElementById('settingsPage');
const editNameInput = document.getElementById('editName');
const editBioInput = document.getElementById('editBio');
const postDestinationSelect = document.getElementById('postDestination');
const channelsPage = document.getElementById('channelsPage');
const channelsGrid = document.getElementById('channelsGrid');
const createChannelForm = document.getElementById('createChannelForm');
const newChannelNameInput = document.getElementById('newChannelName');
const newChannelDescriptionInput = document.getElementById('newChannelDescription');
const channelPage = document.getElementById('channelPage');
const channelInfoDiv = document.getElementById('channelInfo');
const channelPostsContainer = document.getElementById('channelPostsContainer');

let nightLogoTimer = null;
let currentPostType = 'text';
let currentEmbedFormat = 'horizontal';
let currentVideoPageFormat = 'vertical';
let newVideoFormat = 'horizontal';
let isLoadingVideos = false;
let currentUser = null;
let usersData = {}; // Cache per i dati utente
let allPosts = [];
let allVideos = [];
let allUsers = [];
let allChannels = [];
let currentChannelId = null;

const UP_EMOJIS = ['üòç', 'üíû', '‚ù§Ô∏è‚Äçüî•', 'üòò', 'üëç'];
const DOWN_EMOJIS = ['ü§¢', 'ü§Æ', 'üëé', 'üí©', 'üò±', 'üò¢'];

async function loadAllData() {
    try {
        const [postsRes, videosRes, usersRes, channelsRes] = await Promise.all([
            fetch(BASE_URL + "/latest", { headers }),
            fetch(VIDEO_URL + "/latest", { headers }),
            fetch(USER_URL + "/latest", { headers }),
            fetch(CHANNEL_URL + "/latest", { headers })
        ]);

        const postsData = await postsRes.json();
        const videosData = await videosRes.json();
        const usersDataRaw = await usersRes.json();
        const channelsData = await channelsRes.json();

        // Controllo e assegno i dati, usando array vuoti come fallback
        allPosts = (postsData && postsData.record && postsData.record.posts) || [];
        allVideos = (videosData && videosData.record && videosData.record.videos) || [];
        allUsers = (usersDataRaw && usersDataRaw.record && usersDataRaw.record.users) || [];
        allChannels = (channelsData && channelsData.record && channelsData.record.channels) || [];

        usersData = allUsers.reduce((map, user) => {
            map[user.email] = user;
            return map;
        }, {});

        const savedUserEmail = localStorage.getItem("currentUserEmail");
        if (savedUserEmail) {
            currentUser = allUsers.find(u => u.email === savedUserEmail);
            if (currentUser) {
                showAppContent();
            } else {
                showAuthContent();
            }
        } else {
            showAuthContent();
        }

        renderPosts(allPosts.filter(p => !p.channelId));
        updatePostDestinationDropdown();

    } catch (err) {
        console.error("Errore nel caricamento dei dati:", err);
        // In caso di errore, mostro la pagina di login e un messaggio all'utente
        alert("Errore nel caricamento dei dati dal server. Riprova pi√π tardi.");
        showAuthContent();
    }
}

// Funzioni di autenticazione
function showLoginPage() {
    loginPage.style.display = 'flex';
    registerPage.style.display = 'none';
    loginEmailInput.focus();
}

function showRegisterPage() {
    loginPage.style.display = 'none';
    registerPage.style.display = 'flex';
    registerNameInput.focus();
    // Seleziona il primo profilo di default
    document.querySelector('#registerProfilePicSelector img').classList.add('selected');
}

async function registerUser() {
    const name = registerNameInput.value.trim();
    const email = registerEmailInput.value.trim();
    const password = registerPasswordInput.value.trim();
    const profilePic = document.querySelector('#registerProfilePicSelector .selected')?.dataset.value;

    if (!name || !email || !password || !profilePic) {
        alert("Compila tutti i campi e seleziona un'immagine profilo!");
        return;
    }

    if (allUsers.find(u => u.email === email)) {
        alert("Esiste gi√† un utente con questa email.");
        return;
    }

    const newUser = { name, email, password, profilePic, bio: "" };
    
    try {
        allUsers.push(newUser);
        await fetch(USER_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ users: allUsers })
        });
        alert("Registrazione completata! Ora puoi accedere.");
        showLoginPage();
    } catch(err) {
        alert("Errore durante la registrazione.");
        console.error(err);
    }
}

async function loginUser() {
    const email = loginEmailInput.value.trim();
    const password = loginPasswordInput.value.trim();

    const user = allUsers.find(u => u.email === email && u.password === password);

    if (user) {
        currentUser = user;
        localStorage.setItem("currentUserEmail", email);
        alert(`Benvenuto, ${currentUser.name}!`);
        showAppContent();
    } else {
        alert("Credenziali non valide.");
    }
}

function logoutUser() {
    currentUser = null;
    localStorage.removeItem("currentUserEmail");
    showAuthContent();
}

function showAuthContent() {
    authContent.style.display = 'block';
    appContent.style.display = 'none';
    showLoginPage();
}

function showAppContent() {
    authContent.style.display = 'none';
    appContent.style.display = 'block';
    updateUserInfo();
    updatePostDestinationDropdown();
    showMainContent();
}

function updateUserInfo() {
    if (currentUser) {
        document.getElementById("userNameDisplay").textContent = currentUser.name;
        document.getElementById("userProfilePic").src = currentUser.profilePic;
        welcomeMessage.style.display = 'flex';
    }
}

function updatePostDestinationDropdown() {
    postDestinationSelect.innerHTML = '<option value="main">Bacheca Principale</option>';
    if (currentUser) {
        const adminChannels = allChannels.filter(c => c.adminEmails.includes(currentUser.email));
        adminChannels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = `Canale: ${channel.name}`;
            postDestinationSelect.appendChild(option);
        });
    }
}

function setPostType(type, button) {
    currentPostType = type;
    postTypeButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    textFields.style.display = 'none';
    videoFields.style.display = 'none';
    embedFields.style.display = 'none';
    twitterFields.style.display = 'none';

    if (type === 'text') {
        textFields.style.display = 'flex';
        postText.focus();
    } else if (type === 'video') {
        videoFields.style.display = 'flex';
        videoDescriptionInput.focus();
    } else if (type === 'embed') {
        embedFields.style.display = 'flex';
        embedDescriptionInput.focus();
    } else if (type === 'twitter') {
        twitterFields.style.display = 'flex';
        twitterLinkInput.focus();
    }
    checkInputs();
}

function setVideoFormat(format) {
    currentEmbedFormat = format;
    embedFormatButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`embed-format-${format}`).classList.add('active');
}

function setNewVideoFormat(format) {
    newVideoFormat = format;
    newVideoFormatButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`new-video-format-${format}`).classList.add('active');
}

function toggleInput() {
    document.getElementById("inputArea").classList.toggle("active");
    if (document.getElementById("inputArea").classList.contains("active")) {
        if (currentPostType === 'text') {
            postText.focus();
        } else if (currentPostType === 'video') {
            videoDescriptionInput.focus();
        } else if (currentPostType === 'embed') {
            embedDescriptionInput.focus();
        } else if (currentPostType === 'twitter') {
            twitterLinkInput.focus();
        }
    }
}

function toggleVideoInput() {
    videoInputArea.classList.toggle('active');
    if (videoInputArea.classList.contains('active')) {
        newVideoDescriptionInput.focus();
    }
}

function checkInputs() {
    let postContentOk = false;
    if (currentPostType === 'text') {
        postContentOk = postText.value.trim().length >= 3;
    } else if (currentPostType === 'video') {
        postContentOk = videoLinkInput.value.trim() !== '';
    } else if (currentPostType === 'embed') {
        postContentOk = embedCodeInput.value.trim() !== '';
    } else if (currentPostType === 'twitter') {
        postContentOk = twitterLinkInput.value.trim() !== '';
    }
    publishBtn.disabled = !postContentOk;
}

function checkNewVideoInputs() {
    const videoOk = newVideoEmbedCodeInput.value.trim() !== '';
    publishVideoBtn.disabled = !videoOk;
}

function toggleTheme() {
    const body = document.body;
    body.classList.toggle("dark-mode");
    const isDarkMode = body.classList.contains("dark-mode");
    localStorage.setItem("theme", isDarkMode ? "dark" : "light");
    updateLogo(isDarkMode);
    if (mainContent.style.display === 'block') {
        renderPosts(allPosts.filter(p => !p.channelId));
    }
    if (videoPage.style.display === 'block') {
        showVideos(currentVideoPageFormat);
    }
    if (window.twttr) {
      window.twttr.widgets.load();
    }
}

function updateLogo(isDarkMode) {
    if (nightLogoTimer) {
        clearTimeout(nightLogoTimer);
        nightLogoTimer = null;
    }
    if (isDarkMode) {
        logoElement.src = "logo2.png";
        nightLogoTimer = setTimeout(() => {
            logoElement.src = "logo3.png";
        }, 1000);
    } else {
        logoElement.src = "logo1.png";
    }
}

function showMainContent() {
    mainContent.style.display = 'block';
    videoPage.style.display = 'none';
    userProfilePage.style.display = 'none';
    settingsPage.style.display = 'none';
    channelsPage.style.display = 'none';
    channelPage.style.display = 'none';
    renderPosts(allPosts.filter(p => !p.channelId));
}

function showVideoPage() {
    mainContent.style.display = 'none';
    videoPage.style.display = 'block';
    userProfilePage.style.display = 'none';
    settingsPage.style.display = 'none';
    channelsPage.style.display = 'none';
    channelPage.style.display = 'none';
    showVideos('vertical', document.getElementById('video-type-shorts'));
}

async function showVideos(type, button) {
    if (isLoadingVideos) return;
    isLoadingVideos = true;

    currentVideoPageFormat = type;
    videoTypeButtons.forEach(btn => btn.classList.remove('active'));
    if (button) {
        button.classList.add('active');
    }

    videoGrid.innerHTML = '';
    videoGrid.className = 'video-page-container';
    if (type === 'vertical') {
        videoGrid.classList.add('shorts-grid');
    }
    
    // Aggiungo un controllo per i dati
    const videosToRender = Array.isArray(allVideos) ? allVideos : [];
    const filteredVideos = videosToRender.filter(video => video.format === type);

    if (filteredVideos.length === 0) {
        videoGrid.innerHTML = `<p style="text-align:center;">Nessun video trovato in questo formato.</p>`;
        isLoadingVideos = false;
        return;
    }
    
    filteredVideos.forEach(video => {
        const videoElement = createVideoItem(video);
        videoGrid.appendChild(videoElement);
    });

    if (window.twttr) {
      window.twttr.widgets.load();
    }

    isLoadingVideos = false;
}

function createVideoItem(video) {
    const videoItem = document.createElement('div');
    videoItem.classList.add('video-page-item');
    if (document.body.classList.contains("dark-mode")) {
      videoItem.classList.add('dark-mode');
    }

    const user = usersData[video.userEmail] || { name: 'Utente Sconosciuto', profilePic: 'profilo1.png' };

    videoItem.innerHTML = `
        <div class="video-content" onclick="openModal('${video.embedCode}', '${video.format}')">
            ${video.format === 'vertical'
                ? `<iframe src="${video.embedCode}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="vertical-video"></iframe>`
                : `<iframe src="${video.embedCode}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`
            }
        </div>
        <div class="video-item-footer">
            <div class="post-header">
                <a href="#" class="user-link" onclick="event.preventDefault(); showUserProfilePage('${user.email}')">
                    <img src="${user.profilePic}" alt="Immagine profilo" class="profile-pic">
                    <span class="user-name">${user.name}</span>
                </a>
            </div>
            <p>${video.text}</p>
            <div class="video-item-actions post-footer">
                <div class="vote-buttons">
                    <button class="vote-btn upvote-btn" data-video-id="${video.id}" onclick="voteVideo(event, '${video.id}', 'up')">üëç</button>
                    <span class="vote-count" id="video-vote-count-${video.id}">${video.votes || 0}</span>
                    <button class="vote-btn downvote-btn" data-video-id="${video.id}" onclick="voteVideo(event, '${video.id}', 'down')">üëé</button>
                </div>
                ${currentUser && currentUser.email === video.userEmail ? `<button class="delete-btn" onclick="deleteVideo('${video.id}')">Elimina</button>` : ''}
            </div>
        </div>
    `;

    return videoItem;
}

function openModal(embedCode, format) {
    const modal = document.getElementById("videoModal");
    const modalVideoContainer = document.getElementById("modalVideoContainer");

    let embedSrc = embedCode;
    let isVertical = format === 'vertical';
    const youtubeId = getYouTubeId(embedCode);

    if (youtubeId) {
        embedSrc = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
    }

    modalVideoContainer.innerHTML = `<iframe src="${embedSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen class="${isVertical ? 'vertical-video' : 'horizontal-video'}"></iframe>`;

    modal.style.display = "flex";
}

function closeModal() {
    const modal = document.getElementById("videoModal");
    const modalVideoContainer = document.getElementById("modalVideoContainer");
    modalVideoContainer.innerHTML = '';
    modal.style.display = "none";
}

function getYouTubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

async function publishNewVideo() {
    const description = newVideoDescriptionInput.value.trim();
    const embedCode = newVideoEmbedCodeInput.value.trim();

    if (!currentUser || embedCode === '') {
        alert("Completa tutti i campi per pubblicare un video.");
        return;
    }

    const newVideo = {
        id: Date.now(),
        userEmail: currentUser.email,
        text: description,
        embedCode: embedCode,
        timestamp: new Date().toISOString(),
        votes: 0,
        format: newVideoFormat
    };

    allVideos.push(newVideo);

    try {
        await fetch(VIDEO_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ videos: allVideos })
        });
        alert("Video pubblicato con successo!");
        newVideoDescriptionInput.value = '';
        newVideoEmbedCodeInput.value = '';
        toggleVideoInput();
        showVideos(newVideo.format, newVideo.format === 'vertical' ? document.getElementById('video-type-shorts') : document.getElementById('video-type-normal'));
    } catch (err) {
        console.error("Errore durante la pubblicazione del video:", err);
        alert("Errore durante la pubblicazione del video.");
    }
}

async function voteVideo(event, videoId, type) {
    event.stopPropagation();
    event.preventDefault();

    const video = allVideos.find(v => v.id == videoId);
    if (!video) return;

    if (type === 'up') {
        video.votes = (video.votes || 0) + 1;
        triggerEmojiRain(event, UP_EMOJIS, 'up');
    } else {
        video.votes = (video.votes || 0) - 1;
        triggerEmojiRain(event, DOWN_EMOJIS, 'down');
    }

    try {
        await fetch(VIDEO_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ videos: allVideos })
        });
        document.getElementById(`video-vote-count-${videoId}`).textContent = video.votes;
    } catch (err) {
        console.error("Errore durante il voto del video:", err);
    }
}

async function deleteVideo(videoId) {
    if (!confirm("Sei sicuro di voler eliminare questo video?")) {
        return;
    }

    allVideos = allVideos.filter(v => v.id != videoId);

    try {
        await fetch(VIDEO_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ videos: allVideos })
        });
        alert("Video eliminato con successo.");
        showVideos(currentVideoPageFormat, currentVideoPageFormat === 'vertical' ? document.getElementById('video-type-shorts') : document.getElementById('video-type-normal'));
    } catch (err) {
        console.error("Errore durante l'eliminazione del video:", err);
        alert("Errore durante l'eliminazione del video.");
    }
}

async function publishPost() {
    if (!currentUser) {
        alert("Devi essere loggato per pubblicare!");
        return;
    }

    let postContent = '';
    let postEmbed = '';
    let postType = currentPostType;
    let postDestination = postDestinationSelect.value;
    let channelId = postDestination === 'main' ? null : postDestination;

    if (channelId) {
        const channel = allChannels.find(c => c.id == channelId);
        if (!channel || !channel.adminEmails.includes(currentUser.email)) {
            alert("Non hai i permessi per pubblicare in questo canale.");
            return;
        }
    }

    if (currentPostType === 'text') {
        postContent = postText.value.trim();
        if (postContent.length < 3) {
            alert("Il post deve contenere almeno 3 caratteri.");
            return;
        }
    } else if (currentPostType === 'video') {
        postContent = videoDescriptionInput.value.trim();
        postEmbed = videoLinkInput.value.trim();
        if (postEmbed === '') {
            alert("Inserisci un link del video.");
            return;
        }
    } else if (currentPostType === 'embed') {
        postContent = embedDescriptionInput.value.trim();
        postEmbed = embedCodeInput.value.trim();
        postType = currentEmbedFormat === 'vertical' ? 'embed-vertical' : 'embed-horizontal';
        if (postEmbed === '') {
            alert("Inserisci un codice di incorporamento.");
            return;
        }
    } else if (currentPostType === 'twitter') {
        postContent = twitterLinkInput.value.trim();
        postEmbed = postContent;
        if (postEmbed === '') {
            alert("Inserisci un link per il post di Twitter.");
            return;
        }
    }

    const newPost = {
        id: Date.now(),
        userEmail: currentUser.email,
        content: postContent,
        timestamp: new Date().toISOString(),
        votes: 0,
        comments: [],
        embed: postEmbed,
        type: postType,
        channelId: channelId
    };

    allPosts.push(newPost);

    try {
        await fetch(BASE_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ posts: allPosts })
        });
        alert("Post pubblicato con successo!");
        postText.value = '';
        videoLinkInput.value = '';
        embedCodeInput.value = '';
        twitterLinkInput.value = '';
        videoDescriptionInput.value = '';
        embedDescriptionInput.value = '';
        publishBtn.disabled = true;
        
        if (channelId) {
             showChannelPage(channelId);
        } else {
             renderPosts(allPosts.filter(p => !p.channelId));
        }
        document.getElementById("inputArea").classList.remove("active");
    } catch (err) {
        console.error("Errore durante la pubblicazione:", err);
        alert("Errore durante la pubblicazione del post.");
    }
}

async function deletePost(postId) {
    if (!confirm("Sei sicuro di voler eliminare questo post?")) {
        return;
    }
    
    allPosts = allPosts.filter(post => post.id != postId);

    try {
        await fetch(BASE_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ posts: allPosts })
        });
        alert("Post eliminato con successo.");
        if (currentChannelId) {
            showChannelPage(currentChannelId);
        } else {
            renderPosts(allPosts.filter(p => !p.channelId));
        }
    } catch (err) {
        console.error("Errore durante l'eliminazione del post:", err);
        alert("Errore durante l'eliminazione del post.");
    }
}

async function vote(event, postId, type) {
    event.stopPropagation();
    event.preventDefault();

    const post = allPosts.find(p => p.id == postId);
    if (!post) return;

    if (type === 'up') {
        post.votes = (post.votes || 0) + 1;
        triggerEmojiRain(event, UP_EMOJIS, 'up');
    } else {
        post.votes = (post.votes || 0) - 1;
        triggerEmojiRain(event, DOWN_EMOJIS, 'down');
    }

    try {
        await fetch(BASE_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ posts: allPosts })
        });
        document.getElementById(`vote-count-${postId}`).textContent = post.votes;
    } catch (err) {
        console.error("Errore durante il voto:", err);
    }
}

async function addComment(postId) {
    const commentInput = document.getElementById(`comment-input-${postId}`);
    const commentText = commentInput.value.trim();

    if (commentText === '') return;
    
    if (!currentUser) {
        alert("Devi essere loggato per commentare!");
        return;
    }

    const post = allPosts.find(p => p.id == postId);
    if (!post) return;

    if (!post.comments) {
        post.comments = [];
    }

    const newComment = {
        userEmail: currentUser.email,
        text: commentText,
        timestamp: new Date().toISOString(),
        commenterName: currentUser.name,
        commenterPic: currentUser.profilePic
    };

    post.comments.push(newComment);

    try {
        await fetch(BASE_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ posts: allPosts })
        });
        commentInput.value = '';
        renderComments(postId, post.comments);
    } catch (err) {
        console.error("Errore durante l'aggiunta del commento:", err);
    }
}

function renderComments(postId, comments) {
    const commentList = document.getElementById(`comment-list-${postId}`);
    commentList.innerHTML = '';
    // Aggiungo un controllo qui
    (comments || []).forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.classList.add('comment');
        commentDiv.innerHTML = `
            <strong>
                <a href="#" class="user-link" onclick="event.preventDefault(); showUserProfilePage('${comment.userEmail}')">
                    <img src="${comment.commenterPic}" alt="Immagine profilo" class="profile-pic" style="width: 20px; height: 20px;">
                    ${comment.commenterName}
                </a>
            </strong>
            <p>${comment.text}</p>
        `;
        commentList.appendChild(commentDiv);
    });
}

function renderPosts(postsToRender, container = postsContainer) {
    // Aggiungo un controllo per i dati
    if (!Array.isArray(postsToRender)) {
        console.error("Dati non validi passati a renderPosts:", postsToRender);
        container.innerHTML = '<p style="text-align:center;">Errore nel caricamento dei post.</p>';
        return;
    }

    container.innerHTML = '';
    const sortedPosts = postsToRender.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (sortedPosts.length === 0) {
        container.innerHTML = '<p style="text-align:center;">Nessun post da visualizzare.</p>';
    }

    sortedPosts.forEach(post => {
        const user = usersData[post.userEmail] || { name: 'Utente Sconosciuto', profilePic: 'profilo1.png' };
        const postComments = post.comments || [];
        
        const postElement = document.createElement('div');
        postElement.classList.add('post');
        
        if (document.body.classList.contains("dark-mode")) {
          postElement.classList.add('dark-mode');
        }

        let postContentHtml = `<p>${post.content}</p>`;
        let postActionsHtml = currentUser && currentUser.email === post.userEmail ? `<button class="delete-btn" onclick="deletePost('${post.id}')">Elimina</button>` : '';
        
        if (post.type === 'embed-horizontal' || post.type === 'embed-vertical') {
            postContentHtml += `
                <div class="post-embed">
                    <iframe src="${post.embed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="${post.type === 'embed-vertical' ? 'vertical-video' : ''}"></iframe>
                </div>
            `;
        } else if (post.type === 'video') {
            const youtubeId = getYouTubeId(post.embed);
            if (youtubeId) {
                postContentHtml += `
                    <div class="post-embed">
                        <iframe src="https://www.youtube.com/embed/${youtubeId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                `;
            }
        } else if (post.type === 'twitter') {
             // Utilizza l'embed nativo di Twitter (X)
            postContentHtml = `
            <blockquote class="twitter-tweet" data-theme="${document.body.classList.contains('dark-mode') ? 'dark' : 'light'}" data-dnt="true">
                <a href="${post.embed}"></a>
            </blockquote>`;
        }
        
        let postHeaderHtml = `
            <div class="post-header">
                <a href="#" class="user-link" onclick="event.preventDefault(); showUserProfilePage('${user.email}')">
                    <img src="${user.profilePic}" alt="Immagine profilo" class="profile-pic">
                    <span class="user-name">${user.name}</span>
                </a>
            </div>
        `;

        if (post.channelId) {
            const channel = allChannels.find(c => c.id == post.channelId);
            if (channel) {
                postHeaderHtml = `
                    <div class="post-header">
                        <a href="#" class="user-link" onclick="event.preventDefault(); showUserProfilePage('${user.email}')">
                            <img src="${user.profilePic}" alt="Immagine profilo" class="profile-pic">
                            <span class="user-name">${user.name}</span>
                        </a>
                        <span style="font-size: 1.2rem;">‚Üí</span>
                        <a href="#" class="channel-link" onclick="event.preventDefault(); showChannelPage('${channel.id}')">
                            <div class="channel-icon">#</div>
                            <span class="channel-name">${channel.name}</span>
                        </a>
                    </div>
                `;
            }
        }
        
        postElement.innerHTML = `
            ${postHeaderHtml}
            ${postContentHtml}
            <div class="post-footer">
                <div class="vote-buttons">
                    <button class="vote-btn upvote-btn" data-post-id="${post.id}" onclick="vote(event, '${post.id}', 'up')">üëç</button>
                    <span class="vote-count" id="vote-count-${post.id}">${post.votes || 0}</span>
                    <button class="vote-btn downvote-btn" data-post-id="${post.id}" onclick="vote(event, '${post.id}', 'down')">üëé</button>
                </div>
                <div class="post-action-buttons">
                    <button class="comment-btn" onclick="toggleComments('${post.id}')">Commenti (${postComments.length})</button>
                    ${postActionsHtml}
                </div>
            </div>
            <div class="comments-section" id="comments-section-${post.id}" style="display:none;">
                <div class="comment-list" id="comment-list-${post.id}"></div>
                <div class="comment-form">
                    <input type="text" id="comment-input-${post.id}" class="comment-input" placeholder="Scrivi un commento..." />
                    <button class="comment-submit-btn" onclick="addComment('${post.id}')">Invia</button>
                </div>
            </div>
        `;
        container.appendChild(postElement);
    });

    if (window.twttr) {
      window.twttr.widgets.load();
    }
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-section-${postId}`);
    const post = allPosts.find(p => p.id == postId);
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        if (post) {
            renderComments(postId, post.comments);
        }
    } else {
        commentsSection.style.display = 'none';
    }
}

function triggerEmojiRain(event, emojis, direction) {
    const rect = event.target.closest('.post, .video-page-item').getBoundingClientRect();
    const rainContainer = document.createElement('div');
    rainContainer.classList.add(direction === 'up' ? 'emoji-rain-up' : 'emoji-rain-down');
    rainContainer.style.top = `${rect.top + window.scrollY}px`;
    rainContainer.style.left = `${rect.left + window.scrollX}px`;
    rainContainer.style.width = `${rect.width}px`;
    rainContainer.style.height = `${rect.height}px`;
    document.body.appendChild(rainContainer);

    for (let i = 0; i < 10; i++) {
        const emoji = document.createElement('span');
        emoji.classList.add('emoji');
        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.style.left = `${Math.random() * 100}%`;
        emoji.style.animation = `${direction === 'up' ? 'fly-up' : 'fly-down'} ${Math.random() * 2 + 1}s ease-out forwards`;
        emoji.style.animationDelay = `${Math.random() * 0.5}s`;
        rainContainer.appendChild(emoji);
    }
    setTimeout(() => rainContainer.remove(), 2000);
}

// Funzione di ricerca utente e canale
searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    if (query.length > 0) {
        const filteredUsers = allUsers.filter(user => user.name.toLowerCase().includes(query) || user.email.toLowerCase().includes(query));
        const filteredChannels = allChannels.filter(channel => channel.name.toLowerCase().includes(query) || channel.description.toLowerCase().includes(query));
        renderSearchResults(filteredUsers, filteredChannels);
    } else {
        searchResults.style.display = 'none';
    }
});

document.addEventListener('click', (event) => {
    if (document.getElementById('searchArea') && !document.getElementById('searchArea').contains(event.target)) {
        searchResults.style.display = 'none';
    }
});

function renderSearchResults(users, channels) {
    searchResults.innerHTML = '';
    const allResults = [...users.map(u => ({...u, type: 'user'})), ...channels.map(c => ({...c, type: 'channel'}))];

    if (allResults.length > 0) {
        allResults.forEach(result => {
            const resultItem = document.createElement('a');
            resultItem.classList.add('search-result-item');
            resultItem.href = '#';

            if (result.type === 'user') {
                resultItem.onclick = (e) => {
                    e.preventDefault();
                    showUserProfilePage(result.email);
                };
                resultItem.innerHTML = `
                    <img src="${result.profilePic}" alt="Immagine profilo" />
                    <span>${result.name}</span>
                `;
            } else if (result.type === 'channel') {
                resultItem.classList.add('channel-result');
                resultItem.onclick = (e) => {
                    e.preventDefault();
                    showChannelPage(result.id);
                };
                resultItem.innerHTML = `
                    <div class="channel-icon">#</div>
                    <span>${result.name}</span>
                `;
            }
            searchResults.appendChild(resultItem);
        });
        searchResults.style.display = 'block';
    } else {
        searchResults.style.display = 'none';
    }
}

function showUserProfilePage(userEmail) {
    const user = allUsers.find(u => u.email === userEmail);
    if (!user) {
        alert("Utente non trovato.");
        return;
    }

    currentChannelId = null;
    mainContent.style.display = 'none';
    videoPage.style.display = 'none';
    settingsPage.style.display = 'none';
    channelsPage.style.display = 'none';
    channelPage.style.display = 'none';
    userProfilePage.style.display = 'block';

    profileInfoDiv.innerHTML = `
        <img src="${user.profilePic}" alt="Immagine profilo" />
        <h2>${user.name}</h2>
        <p>${user.email}</p>
        <p>${user.bio || 'Nessuna bio inserita.'}</p>
    `;

    const userPosts = allPosts.filter(post => post.userEmail === userEmail);
    renderPosts(userPosts, userPostsContainer);

    const userVideos = allVideos.filter(video => video.userEmail === userEmail);
    renderUserVideos(userVideos, userVideosContainer);
}

function renderUserVideos(videos, container) {
    container.innerHTML = '';
    if (videos.length === 0) {
        container.innerHTML = '<p>Nessun video pubblicato.</p>';
        return;
    }
    videos.forEach(video => {
        const videoElement = createVideoItem(video);
        container.appendChild(videoElement);
    });
}

function showSettingsPage() {
    if (!currentUser) {
        alert("Devi essere loggato per accedere alle impostazioni.");
        return;
    }
    
    currentChannelId = null;
    mainContent.style.display = 'none';
    videoPage.style.display = 'none';
    userProfilePage.style.display = 'none';
    channelsPage.style.display = 'none';
    channelPage.style.display = 'none';
    settingsPage.style.display = 'block';

    editNameInput.value = currentUser.name;
    editBioInput.value = currentUser.bio || '';
    
    document.querySelectorAll('#settingsProfilePicSelector img').forEach(img => {
      img.classList.remove('selected');
    });

    const currentProfilePicImg = document.querySelector(`#settingsProfilePicSelector img[data-value='${currentUser.profilePic}']`);
    if (currentProfilePicImg) {
      currentProfilePicImg.classList.add('selected');
    }
}

async function saveSettings() {
    if (!currentUser) {
        alert("Errore: Utente non loggato.");
        return;
    }

    const newName = editNameInput.value.trim();
    const newProfilePic = document.querySelector('#settingsProfilePicSelector .selected')?.dataset.value;
    const newBio = editBioInput.value.trim();

    if (!newName || !newProfilePic) {
        alert("Nome e immagine profilo non possono essere vuoti.");
        return;
    }

    const userIndex = allUsers.findIndex(u => u.email === currentUser.email);
    if (userIndex !== -1) {
        allUsers[userIndex].name = newName;
        allUsers[userIndex].profilePic = newProfilePic;
        allUsers[userIndex].bio = newBio;
        currentUser.name = newName;
        currentUser.profilePic = newProfilePic;
        currentUser.bio = newBio;
    }
    
    allPosts.forEach(post => {
        const postComments = post.comments || [];
        postComments.forEach(comment => {
            if (comment.userEmail === currentUser.email) {
                comment.commenterName = newName;
                comment.commenterPic = newProfilePic;
            }
        });
    });

    try {
        await fetch(USER_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ users: allUsers })
        });
        await fetch(BASE_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ posts: allPosts })
        });
        alert("Impostazioni salvate con successo!");
        updateUserInfo();
        showMainContent();
    } catch (err) {
        console.error("Errore durante il salvataggio delle impostazioni:", err);
        alert("Errore durante il salvataggio delle impostazioni.");
    }
}

function selectProfilePic(selectedImg, page) {
    const parentSelector = page === 'register' ? '#registerProfilePicSelector' : '#settingsProfilePicSelector';
    document.querySelectorAll(`${parentSelector} img`).forEach(img => {
        img.classList.remove('selected');
    });
    selectedImg.classList.add('selected');
}

// Funzionalit√† per i canali
function showChannelsPage() {
    mainContent.style.display = 'none';
    videoPage.style.display = 'none';
    userProfilePage.style.display = 'none';
    settingsPage.style.display = 'none';
    channelPage.style.display = 'none';
    channelsPage.style.display = 'block';
    renderChannels();
}

function showCreateChannelForm() {
    createChannelForm.classList.toggle('active');
}

async function createChannel() {
    if (!currentUser) {
        alert("Devi essere loggato per creare un canale.");
        return;
    }
    const name = newChannelNameInput.value.trim();
    const description = newChannelDescriptionInput.value.trim();

    if (!name || !description) {
        alert("Compila tutti i campi.");
        return;
    }
    
    if (allChannels.some(c => c.name.toLowerCase() === name.toLowerCase())) {
        alert("Esiste gi√† un canale con questo nome.");
        return;
    }

    const newChannel = {
        id: Date.now(),
        name,
        description,
        adminEmails: [currentUser.email]
    };

    allChannels.push(newChannel);

    try {
        await fetch(CHANNEL_URL, {
            method: "PUT",
            headers,
            body: JSON.stringify({ channels: allChannels })
        });
        alert("Canale creato con successo!");
        newChannelNameInput.value = '';
        newChannelDescriptionInput.value = '';
        createChannelForm.classList.remove('active');
        renderChannels();
        updatePostDestinationDropdown();
    } catch (err) {
        console.error("Errore durante la creazione del canale:", err);
        alert("Errore durante la creazione del canale.");
    }
}

function renderChannels() {
    channelsGrid.innerHTML = '';
    if (allChannels.length === 0) {
        channelsGrid.innerHTML = '<p style="text-align:center;">Nessun canale creato.</p>';
        return;
    }
    
    allChannels.forEach(channel => {
        const channelCard = document.createElement('div');
        channelCard.classList.add('channel-card');
        channelCard.onclick = () => showChannelPage(channel.id);
        channelCard.innerHTML = `
            <div class="channel-icon">#</div>
            <h3>${channel.name}</h3>
            <p>${channel.description}</p>
        `;
        channelsGrid.appendChild(channelCard);
    });
}

function showChannelPage(channelId) {
    const channel = allChannels.find(c => c.id == channelId);
    if (!channel) {
        alert("Canale non trovato.");
        return;
    }
    
    currentChannelId = channelId;
    mainContent.style.display = 'none';
    videoPage.style.display = 'none';
    userProfilePage.style.display = 'none';
    settingsPage.style.display = 'none';
    channelsPage.style.display = 'none';
    channelPage.style.display = 'block';

    const isAdmin = currentUser && channel.adminEmails.includes(currentUser.email);
    let adminButtonsHtml = '';
    if (isAdmin) {
        adminButtonsHtml = `
            <div class="channel-admin-buttons">
                <button onclick="toggleAdminPanel()">Gestisci amministratori</button>
            </div>
            <div id="adminPanel" class="channel-admin-section" style="display: none;">
                <p>Amministratori attuali: ${channel.adminEmails.join(', ')}</p>
                <input type="email" id="newAdminEmail" placeholder="Email del nuovo amministratore" />
                <button onclick="addAdminToChannel('${channel.id}')">Aggiungi amministratore</button>
            </div>
        `;
    }

    channelInfoDiv.innerHTML = `
        <div class="channel-icon">#</div>
        <h2>${channel.name}</h2>
        <p>${channel.description}</p>
        ${adminButtonsHtml}
    `;

    const channelPosts = allPosts.filter(post => post.channelId == channelId);
    renderPosts(channelPosts, channelPostsContainer);
}

function toggleAdminPanel() {
    document.getElementById('adminPanel').classList.toggle('active');
}

async function addAdminToChannel(channelId) {
    const channel = allChannels.find(c => c.id == channelId);
    if (!channel) return;
    
    const newAdminEmail = document.getElementById('newAdminEmail').value.trim();
    if (!newAdminEmail) return;

    if (!channel.adminEmails.includes(newAdminEmail)) {
        channel.adminEmails.push(newAdminEmail);
        try {
            await fetch(CHANNEL_URL, {
                method: "PUT",
                headers,
                body: JSON.stringify({ channels: allChannels })
            });
            alert(`${newAdminEmail} √® stato aggiunto come amministratore.`);
            showChannelPage(channelId);
        } catch (err) {
            console.error("Errore durante l'aggiunta dell'amministratore:", err);
            alert("Errore durante l'aggiunta dell'amministratore.");
        }
    } else {
        alert("Questo utente √® gi√† un amministratore.");
    }
}

document.addEventListener("DOMContentLoaded", () => {
    loadAllData();
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
    }
    updateLogo(document.body.classList.contains("dark-mode"));
});

postText.addEventListener('input', checkInputs);
videoLinkInput.addEventListener('input', checkInputs);
embedCodeInput.addEventListener('input', checkInputs);
twitterLinkInput.addEventListener('input', checkInputs);
newVideoEmbedCodeInput.addEventListener('input', checkNewVideoInputs);
</script>
</body>
</html>