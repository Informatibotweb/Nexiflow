<!DOCTYPE html>
<html lang="it">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHXQ3M8FYD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BHXQ3M8FYD');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexiflow™ by Nexiquar</title>
  <link rel="icon" type="image/png" href="nexiflow.png">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap');
    
    :root {
      --bg-light: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      --text-light: #111;
      --card-light: #ffffff;
      --bg-dark: linear-gradient(135deg, #1e1e1e, #0c0c0c);
      --text-dark: #f0f0f0;
      --card-dark: #121212;
      --primary-color: #6a11cb;
      --primary-hover: #5a0eb5;
      --primary-active: #4c0ca0;
      --secondary-color: #2575fc;
      --secondary-hover: #2168e6;
      --secondary-active: #1e5ad0;
      --icon-color: #888;
      --icon-hover: #555;
    }

    body {
      font-family: 'Quicksand', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s ease;
      position: relative;
    }

    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .auth-card {
      background-color: var(--card-light);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
      transition: background-color 0.3s ease;
    }

    .dark-mode .auth-card {
      background-color: var(--card-dark);
    }

    .logo-container {
      margin-bottom: 20px;
    }

    .logo-container img {
      width: 80px;
      height: auto;
    }

    h1 {
      font-size: 2.2rem;
      margin: 0;
      color: var(--primary-color);
      letter-spacing: -1px;
    }

    .subtitle {
      font-size: 1rem;
      color: var(--icon-color);
      margin-top: 5px;
      margin-bottom: 25px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input[type="email"],
    input[type="password"] {
      padding: 15px 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.3s;
      background-color: transparent;
      color: var(--text-light);
    }

    .dark-mode input[type="email"],
    .dark-mode input[type="password"] {
      border-color: #333;
      color: var(--text-dark);
    }

    input[type="email"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    button {
      padding: 15px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      color: white;
      transition: background-color 0.3s, transform 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      background: var(--primary-active);
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--secondary-color);
    }

    .btn-secondary:hover {
      background: var(--secondary-hover);
      transform: translateY(-2px);
    }

    .btn-secondary:active {
      background: var(--secondary-active);
      transform: translateY(0);
    }

    .divider {
      position: relative;
      text-align: center;
      margin: 20px 0;
      color: #aaa;
    }

    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background-color: #ddd;
    }

    .dark-mode .divider::before,
    .dark-mode .divider::after {
        background-color: #333;
    }

    .divider::before {
      left: 0;
    }

    .divider::after {
      right: 0;
    }

    .social-auth {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .social-auth button {
      background-color: transparent;
      border: 1px solid #ddd;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 50%;
      transition: border-color 0.3s, background-color 0.3s;
    }

    .dark-mode .social-auth button {
        border-color: #333;
    }

    .social-auth button:hover {
      background-color: #f0f0f0;
      border-color: #bbb;
    }

    .dark-mode .social-auth button:hover {
        background-color: #222;
        border-color: #555;
    }

    .social-auth img {
      width: 25px;
    }

    .auth-toggle {
      margin-top: 20px;
      font-size: 0.9rem;
      color: var(--icon-color);
    }

    .auth-toggle a {
      color: var(--primary-color);
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
    }

    .app-content {
      display: none;
      width: 100%;
      height: 100%;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .app-content h1 {
      font-size: 3rem;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .modal .auth-card {
        padding: 2rem;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .modal h2 {
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .modal p {
        color: var(--icon-color);
        margin-bottom: 1.5rem;
    }

    .modal select {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        width: 100%;
        margin-bottom: 1rem;
    }

  </style>
</head>
<body>
  <div class="container" id="auth-container">
    <div class="auth-card">
      <div class="logo-container">
        <img src="https://assets.website-files.com/65330a1336d3923053123b37/653315a636d3923053155708_nexiflow-icon.svg" alt="Nexiflow Logo" />
      </div>
      <h1 id="form-title">Login</h1>
      <p class="subtitle">Accedi o registrati al tuo account per continuare</p>
      
      <form class="auth-form" id="login-form">
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit" class="btn-primary">Accedi</button>
      </form>

      <form class="auth-form" id="register-form" style="display: none;">
        <input type="email" id="register-email" placeholder="Email" required />
        <input type="password" id="register-password" placeholder="Password" required />
        <button type="submit" class="btn-primary">Registrati</button>
      </form>

      <div class="divider">oppure</div>

      <div class="social-auth">
        <div id="g_id_onload"
             data-client_id="YOUR_GOOGLE_CLIENT_ID"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>

        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
      </div>

      <div class="auth-toggle">
        <span id="toggle-text">Non hai un account?</span> <a href="#" id="toggle-link">Registrati</a>
      </div>
    </div>
  </div>

  <div class="container" id="app-container" style="display: none;">
    <div class="app-content">
      <h1 id="welcome-message"></h1>
      <button class="btn-primary" onclick="logout()">Logout</button>
      <button class="btn-primary" onclick="window.location.reload()">Vai al login</button>
    </div>
  </div>

  <!-- Modal per la selezione del paese -->
  <div id="countryModal" class="modal">
    <div class="auth-card">
        <h2>Seleziona il tuo Paese</h2>
        <p>Completa il tuo profilo prima di accedere a Nexiflow.</p>
        <select id="countryDropdown" style="width:100%; padding: 10px; border-radius: 10px; font-size: 1rem;"></select>
        <button class="btn-primary" onclick="saveCountry()">Salva e Continua</button>
    </div>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <script>
    // Questo è un placeholder per l'array di tutti gli utenti.
    // In un progetto reale, questo verrebbe gestito lato server.
    let allUsers = []; 
    let currentUser = null;

    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const welcomeMessage = document.getElementById('welcome-message');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const formTitle = document.getElementById('form-title');
    const toggleLink = document.getElementById('toggle-link');
    const toggleText = document.getElementById('toggle-text');
    const themeToggle = document.getElementById('theme-toggle');

    const countryDropdown = document.getElementById('countryDropdown');
    const countryModal = document.getElementById('countryModal');

    // Funzione per popolare il dropdown dei paesi
    const countries = [
        "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua e Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaigian", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Bielorussia", "Belgio", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia ed Erzegovina", "Botswana", "Brasile", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Capo Verde", "Cambogia", "Camerun", "Canada", "Repubblica Centrafricana", "Ciad", "Cile", "Cina", "Colombia", "Comore", "Repubblica Democratica del Congo", "Repubblica del Congo", "Costa Rica", "Costa d'Avorio", "Croazia", "Cuba", "Cipro", "Repubblica Ceca", "Danimarca", "Gibuti", "Dominica", "Repubblica Dominicana", "Ecuador", "Egitto", "El Salvador", "Guinea Equatoriale", "Eritrea", "Estonia", "Eswatini", "Etiopia", "Fiji", "Finlandia", "Francia", "Gabon", "Gambia", "Georgia", "Germania", "Ghana", "Grecia", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Ungheria", "Islanda", "India", "Indonesia", "Iran", "Iraq", "Irlanda", "Israele", "Italia", "Giamaica", "Giappone", "Giordania", "Kazakistan", "Kenya", "Kiribati", "Corea del Nord", "Corea del Sud", "Kosovo", "Kuwait", "Kirghizistan", "Laos", "Lettonia", "Libano", "Lesotho", "Liberia", "Libia", "Liechtenstein", "Lituania", "Lussemburgo", "Madagascar", "Malawi", "Malaysia", "Maldive", "Mali", "Malta", "Isole Marshall", "Mauritania", "Mauritius", "Messico", "Micronesia", "Moldavia", "Monaco", "Mongolia", "Montenegro", "Marocco", "Mozambico", "Myanmar", "Namibia", "Nauru", "Nepal", "Paesi Bassi", "Nuova Zelanda", "Nicaragua", "Niger", "Nigeria", "Macedonia del Nord", "Norvegia", "Oman", "Pakistan", "Palau", "Palestina", "Panama", "Papua Nuova Guinea", "Paraguay", "Perù", "Filippine", "Polonia", "Portogallo", "Qatar", "Romania", "Russia", "Ruanda", "Saint Kitts e Nevis", "Saint Lucia", "Saint Vincent e Grenadine", "Samoa", "San Marino", "Sao Tome e Principe", "Arabia Saudita", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovacchia", "Slovenia", "Isole Salomone", "Somalia", "Sudafrica", "Sud Sudan", "Spagna", "Sri Lanka", "Sudan", "Suriname", "Svezia", "Svizzera", "Siria", "Taiwan", "Tagikistan", "Tanzania", "Thailandia", "Timor-Est", "Togo", "Tonga", "Trinidad e Tobago", "Tunisia", "Turchia", "Turkmenistan", "Tuvalu", "Uganda", "Ucraina", "Emirati Arabi Uniti", "Regno Unito", "Stati Uniti d'America", "Uruguay", "Uzbekistan", "Vanuatu", "Città del Vaticano", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];
    
    function populateCountryDropdown() {
      countryDropdown.innerHTML = '<option value="">Seleziona...</option>';
      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryDropdown.appendChild(option);
      });
    }

    // Funzioni per la gestione della visibilità
    function showAuthContent() {
      authContainer.style.display = 'flex';
      appContainer.style.display = 'none';
      countryModal.style.display = 'none';
    }

    function showAppContent() {
      authContainer.style.display = 'none';
      appContainer.style.display = 'flex';
      welcomeMessage.textContent = `Benvenuto, ${currentUser.name}!`;
    }

    function showCountryModal() {
        countryModal.style.display = 'flex';
    }

    // Funzione per salvare il paese selezionato
    function saveCountry() {
        const selectedCountry = countryDropdown.value;
        if (selectedCountry) {
            // Salva il paese nel localStorage
            let allUsers = JSON.parse(localStorage.getItem('allUsers')) || [];
            let user = allUsers.find(u => u.googleId === currentUser.googleId);
            if (user) {
                user.country = selectedCountry;
                localStorage.setItem('allUsers', JSON.stringify(allUsers));
                currentUser.country = selectedCountry;
            }
            countryModal.style.display = 'none';
            showAppContent();
        } else {
            alert("Seleziona un paese per continuare.");
        }
    }

    // Funzione che gestisce la risposta di Google Sign-In
    async function handleCredentialResponse(response) {
      const responsePayload = decodeJwtResponse(response.credential);
      let allUsers = JSON.parse(localStorage.getItem('allUsers')) || [];
      let user = allUsers.find(u => u.googleId === responsePayload.sub);

      if (!user) {
        // L'utente è nuovo, lo salviamo e mostriamo il modale del paese
        user = {
          googleId: responsePayload.sub,
          name: responsePayload.name,
          email: responsePayload.email,
          profilePic: responsePayload.picture,
          country: null // Il paese è inizialmente nullo
        };
        allUsers.push(user);
        localStorage.setItem('allUsers', JSON.stringify(allUsers));
        currentUser = user;
        showCountryModal();
      } else {
        currentUser = user;
        // Controlla se il paese è già stato selezionato
        if (currentUser.country) {
          showAppContent();
        } else {
          showCountryModal();
        }
      }
    }

    // Funzione per decodificare il JWT
    function decodeJwtResponse(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }
    
    // Funzione per il logout
    function logout() {
      currentUser = null;
      localStorage.removeItem("currentUserEmail");
      localStorage.removeItem("allUsers"); // Rimuoviamo anche gli utenti per la demo
      showAuthContent();
    }

    // Logica di gestione del tema
    themeToggle.addEventListener('change', () => {
      document.body.classList.toggle('dark-mode');
    });

    // Logica per il toggle tra login e registrazione
    toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'flex';
        registerForm.style.display = 'none';
        formTitle.textContent = 'Login';
        toggleText.textContent = 'Non hai un account?';
        toggleLink.textContent = 'Registrati';
      } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'flex';
        formTitle.textContent = 'Registrazione';
        toggleText.textContent = 'Hai già un account?';
        toggleLink.textContent = 'Accedi';
      }
    });

    // Simulazione di una fetch al login classico (mantieni per coerenza)
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const user = allUsers.find(u => u.email === email);
      if (user) {
        currentUser = user;
        localStorage.setItem("currentUserEmail", currentUser.email);
        showAppContent();
      } else {
        alert("Utente non trovato.");
      }
    });

    // Funzione per caricare gli utenti esistenti (simulazione)
    function loadExistingUsers() {
      const storedUsers = localStorage.getItem('allUsers');
      if (storedUsers) {
        allUsers = JSON.parse(storedUsers);
      }
    }

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', () => {
      loadExistingUsers();
      populateCountryDropdown();
    });

  </script>
</body>
</html>
